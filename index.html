<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SEO Audit Tool - Production Deployment Test -->
    <!-- Updated: Testing Cloudflare Pages deployment with all secrets configured -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attention is all you need - Simple SEO & Technical Audit</title>
    <link rel="stylesheet" href="dist/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Modern Design System Styles */
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #0D1117;
            color: white;
            min-height: 100vh;
        }
        
        /* Glass morphism effects */
        .glass-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.04);
        }
        
        /* Score circle components */
        .score-circle {
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .score-circle svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        
        .score-circle .progress {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dasharray 1.5s ease-in-out;
        }
        
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 16px;
        }
        
        /* Status indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-indicator.status-good { background-color: #2EA043; }
        .status-indicator.status-warning { background-color: #FB8500; }
        .status-indicator.status-danger { background-color: #F85149; }
        
        /* Text status colors (for score text) */
        .status-good { color: #2EA043 !important; }
        .status-warning { color: #FB8500 !important; }
        .status-error, .status-danger { color: #F85149 !important; }
        
        /* Executive summary styling */
        .executive-summary {
            background: linear-gradient(135deg, #0066FF08 0%, #2EA04308 100%);
            border-left: 3px solid #0066FF;
        }
        
        .business-impact {
            background: linear-gradient(135deg, #2EA04308 0%, #FB850008 100%);
            border-left: 3px solid #2EA043;
        }
        
        /* Collapsible sections */
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .collapsible.expanded {
            max-height: 2000px;
        }
        
        /* Legacy compatibility */
        .test-result {
            transition: all 0.3s ease;
        }
        
        .test-result:hover {
            background: rgba(0, 102, 255, 0.05);
        }
        
        /* Updated color scheme */
        .text-green-400, .status-good { color: #2EA043 !important; }
        .text-yellow-400, .text-orange-400, .status-warning { color: #FB8500 !important; }
        .text-red-400, .status-error { color: #F85149 !important; }
        .text-blue-400, .text-violet-400 { color: #0066FF !important; }
        
        .bg-green-400 { background-color: #2EA043 !important; }
        .bg-orange-400, .bg-yellow-400 { background-color: #FB8500 !important; }
        .bg-red-400 { background-color: #F85149 !important; }
        .bg-blue-400, .bg-violet-400 { background-color: #0066FF !important; }
        
        /* Preserved animations */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 102, 255, 0.3);
            border-top-color: #0066FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .scan-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        pre {
            background: #21262D;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
        }
        
        /* Attention Cards - improved layout with better spacing */
        /* Attention Cards Responsive Layout */
        .attention-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
            width: 100%;
        }
        
        /* Tablet and smaller desktop - still try to fit horizontally */
        @media (max-width: 1200px) {
            .attention-cards {
                gap: 1rem;
            }
        }
        
        /* Medium tablet - switch to 2 columns */
        @media (max-width: 900px) {
            .attention-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        
        /* Mobile: Stack vertically */
        @media (max-width: 640px) {
            .attention-cards {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin: 1.5rem 0;
            }
            
            .attention-card {
                min-width: 100%;
                flex-shrink: 0;
            }
        }
        
        /* Extra small mobile */
        @media (max-width: 480px) {
            .attention-cards {
                gap: 0.75rem;
                margin: 1rem 0;
            }
        }
        
        .attention-card {
            position: relative;
            transition: all 0.3s ease;
            min-height: 180px;
        }
        
        .attention-card:hover {
            transform: translateY(-4px);
        }
        
        /* Hide scrollbar but keep functionality */
        .attention-cards::-webkit-scrollbar {
            height: 4px;
        }
        
        .attention-cards::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }
        
        .attention-cards::-webkit-scrollbar-thumb {
            background: rgba(0, 102, 255, 0.3);
            border-radius: 2px;
        }
        
        .attention-cards::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 102, 255, 0.5);
        }
        
        /* Additional Mobile Optimizations */
        @media (max-width: 640px) {
            /* Hero section padding */
            .hero-section {
                padding: 1.5rem 1rem;
            }
            
            /* Card content spacing */
            .glass-card {
                margin: 0 1rem;
                border-radius: 1rem;
            }
            
            /* Button text wrapping */
            .btn-responsive {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Ensure proper touch targets */
            button, .button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Improve text readability on mobile */
            .text-responsive {
                font-size: 0.875rem;
                line-height: 1.5;
            }
            
            /* Better spacing for stacked elements */
            .mobile-stack > * + * {
                margin-top: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small mobile optimizations */
            .glass-card {
                margin: 0 0.5rem;
                padding: 1rem !important;
                border-radius: 0.75rem;
            }
            
            h1 {
                font-size: 2rem !important;
                line-height: 1.2 !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            h3 {
                font-size: 1.25rem !important;
            }
            
            /* Compact button spacing */
            .button-group {
                gap: 0.5rem;
            }
        }
        
        /* Mobile-first responsive grid overrides */
        @media (max-width: 768px) {
            /* Convert 4-column grids to 2-column on mobile */
            .grid-cols-2.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            
            /* Convert 3-column grids to 1-column on mobile */
            .grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
            
            /* Reduce gaps on mobile */
            .gap-6 {
                gap: 1rem !important;
            }
            
            .gap-4 {
                gap: 0.75rem !important;
            }
            
            /* Stack flex items on mobile */
            .flex-col-mobile {
                flex-direction: column !important;
            }
            
            /* Full width on mobile */
            .w-full-mobile {
                width: 100% !important;
            }
            
            /* Hide on mobile */
            .hidden-mobile {
                display: none !important;
            }
            
            /* Show only on mobile */
            .mobile-only {
                display: block !important;
            }
        }
        
        /* Hide mobile-only content by default */
        .mobile-only {
            display: none;
        }
        
        @media (min-width: 769px) {
            /* Show mobile-only content on desktop */
            .mobile-only {
                display: none !important;
            }
        }
    </style>
    <!-- Load Component Library -->
    <script src="components/attention-components.js"></script>
</head>
<body class="bg-profound-dark text-white font-sans antialiased">

    <!-- Modern Navigation Header -->
    <nav class="fixed top-0 w-full z-50 glass-card">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-profound-blue rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">A</span>
                    </div>
                    <span class="font-bold text-lg">attentionisallyouneed.app</span>
                </div>
                <!-- Server Status -->
                <div id="serverStatus" class="flex items-center gap-2 px-3 py-2 glass-card rounded-lg">
                    <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                    <span id="statusText" class="text-sm text-gray-400">Checking server...</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8 max-w-7xl relative z-10" style="margin-top: 60px;">
        
        <!-- Modern Header - Mobile Optimized -->
        <div class="hero-section text-center mb-8 sm:mb-12">
            <h1 class="text-3xl sm:text-4xl lg:text-6xl font-bold mb-4 sm:mb-6 leading-tight">
                Attention is all you <span class="text-profound-blue">need.</span>
            </h1>
            <p class="text-lg sm:text-xl text-gray-300 mb-3 sm:mb-4 font-light px-2 sm:px-0">
                A simple, no-fuss SEO & technical audit tool — built for the age of AI search.
            </p>
            <p class="text-sm sm:text-base text-gray-400 mb-6 sm:mb-8 font-light max-w-3xl mx-auto px-4 sm:px-0">
                Because yes, "attention is all you need" in AI… but you'll also need schema markup, a polite robots.txt, and a way to explain bounce rate vs conversion rate.
            </p>
        </div>
        
        <!-- Modern Input Section - Mobile Optimized -->
        <div class="glass-card rounded-2xl p-4 sm:p-6 lg:p-8 mb-8">
            <div class="space-y-4">
                <!-- URL Input Row -->
                <div class="w-full">
                    <label class="block text-sm text-gray-400 mb-2 font-medium">
                        <i class="fas fa-globe mr-2"></i>Target URL
                    </label>
                    <input 
                        type="url" 
                        id="urlInput"
                        placeholder="https://example.com"
                        class="w-full px-4 py-3 bg-profound-gray rounded-lg text-white border border-profound-border focus:border-profound-blue focus:outline-none focus:ring-2 focus:ring-profound-blue/20 transition-colors"
                    >
                </div>
                
                <!-- Controls Section -->
                <div class="space-y-3 sm:space-y-0">
                    <!-- Primary Controls Row -->
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                        <!-- Lighthouse Checkbox -->
                        <div class="flex items-center">
                            <label class="flex items-center gap-2 text-sm text-gray-400">
                                <input type="checkbox" id="lhCheckbox" class="accent-profound-blue">
                                <span class="hidden sm:inline">Run Lighthouse (slower)</span>
                                <span class="sm:hidden">Lighthouse</span>
                            </label>
                        </div>
                        
                        <!-- Primary Action Button -->
                        <div class="flex-1 sm:flex-none">
                            <button 
                                onclick="startFullAudit()"
                                id="auditBtn"
                                class="w-full sm:w-auto px-4 sm:px-8 py-3 bg-profound-blue text-white rounded-lg font-semibold hover:bg-blue-600 transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <i class="fas fa-search"></i>
                                <span class="hidden md:inline">Run a Free Attention Report →</span>
                                <span class="md:hidden">Analyze Site</span>
                            </button>
                            <p class="text-xs text-gray-400 mt-2 text-center sm:text-left">
                                <span class="hidden sm:inline">(Takes ~30s. Robots will not be harmed in the process.)</span>
                                <span class="sm:hidden">Takes ~30s</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Secondary Actions Row -->
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <!-- Left side buttons -->
                        <div class="flex gap-2 flex-1">
                            <button 
                                onclick="startBatchAudit()"
                                id="batchBtn"
                                class="flex-1 sm:flex-none px-3 sm:px-6 py-3 bg-profound-gray rounded-lg hover:bg-gray-600 transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Analyze multiple URLs"
                            >
                                <i class="fas fa-layer-group"></i>
                                <span class="hidden sm:inline">Batch</span>
                            </button>
                            <button 
                                onclick="clearCache()"
                                class="flex-1 sm:flex-none px-3 sm:px-4 py-3 bg-profound-gray rounded-lg hover:bg-gray-600 transition-all duration-200 flex items-center justify-center"
                                title="Clear cache"
                            >
                                <i class="fas fa-trash"></i>
                                <span class="sm:hidden ml-1">Clear</span>
                            </button>
                        </div>
                        
                        <!-- Sitemap controls -->
                        <div class="flex items-center gap-2 sm:gap-3">
                            <button 
                                onclick="startSitemapAudit()"
                                id="sitemapBtn"
                                class="flex-1 sm:flex-none px-3 sm:px-6 py-3 bg-success text-white rounded-lg hover:bg-green-700 transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Scan entire sitemap"
                            >
                                <i class="fas fa-sitemap"></i>
                                <span class="hidden sm:inline">Sitemap</span>
                            </button>
                            <div class="flex items-center gap-1 sm:gap-2">
                                <input 
                                    type="number" 
                                    id="maxUrlsInput"
                                    placeholder="50"
                                    min="1"
                                    max="200"
                                    class="w-12 sm:w-16 px-2 py-3 bg-profound-gray rounded text-white text-sm border border-profound-border focus:border-success focus:outline-none text-center"
                                    title="Max URLs to analyze (1-200)"
                                >
                                <span class="text-xs text-gray-400">pages</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modern Progress Section -->
        <div id="progressSection" class="hidden mb-8">
            <div class="glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-300 font-medium">Analysis in progress</span>
                    <span id="progressText" class="text-profound-blue font-bold scan-animation">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...
                    </span>
                </div>
                <div id="currentTest" class="mt-4 text-sm text-gray-500"></div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="hidden space-y-6">
            
            <!-- Attention Overview Dashboard -->
            <div id="executiveSummaryContainer" class="executive-summary rounded-2xl p-8 mb-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">Attention Overview</h2>
                        <p class="text-gray-400">TL;DR for stakeholders who need the bottom line</p>
                    </div>
                    <div class="text-right" id="overallScoreDisplay">
                        <div class="text-4xl font-bold text-profound-blue" id="overallScore">-</div>
                        <div class="text-sm text-gray-400">Overall Score</div>
                    </div>
                </div>
                <div id="executiveMetrics" class="w-full mb-6 sm:mb-8">
                    <!-- Executive metrics will be populated here -->
                </div>
                <div id="businessInsights" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Business insights will be populated here -->
                </div>
            </div>
            
            <!-- Legacy Overview Cards (for compatibility) -->
            <div class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="glass-card rounded-lg p-4">
                    <div class="text-gray-400 text-xs uppercase mb-1 font-medium">Performance</div>
                    <div class="text-2xl font-bold" id="perfScore">-</div>
                </div>
                <div class="glass-card rounded-lg p-4">
                    <div class="text-gray-400 text-xs uppercase mb-1 font-medium">Accessibility</div>
                    <div class="text-2xl font-bold" id="a11yScore">-</div>
                </div>
                <div class="glass-card rounded-lg p-4">
                    <div class="text-gray-400 text-xs uppercase mb-1 font-medium">SEO Score</div>
                    <div class="text-2xl font-bold" id="seoScore">-</div>
                </div>
                <div class="glass-card rounded-lg p-4">
                    <div class="text-gray-400 text-xs uppercase mb-1 font-medium">Issues Found</div>
                    <div class="text-2xl font-bold" id="issueCount">-</div>
                </div>
            </div>
            <!-- Structured Attention -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-profound-blue/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <span class="text-2xl">📋</span>
                        Structured Attention — schema helps robots stop confusing you with your evil twin.
                    </h2>
                </div>
                <div id="schemaResults" class="p-6"></div>
            </div>
            
            <!-- Metadata -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-profound-blue/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-tags text-profound-blue"></i>
                        Metadata Analysis
                    </h2>
                </div>
                <div id="metadataResults" class="p-6"></div>
            </div>
            
            <!-- User Attention -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-success/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <span class="text-2xl">👥</span>
                        User Attention — if people leave, robots don't matter.
                    </h2>
                </div>
                <div id="performanceResults" class="p-6"></div>
            </div>
            
            <!-- Accessibility (part of User Attention) -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-success/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <span class="text-2xl">♿</span>
                        Accessibility — everyone deserves to use your site.
                    </h2>
                </div>
                <div id="accessibilityResults" class="p-6"></div>
            </div>
            
            <!-- External Files -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-profound-blue/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-file-alt text-profound-blue"></i>
                        External Files & Resources
                    </h2>
                </div>
                <div id="filesResults" class="p-6"></div>
            </div>

            <!-- Headers / CDN -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-profound-blue/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-network-wired text-profound-blue"></i>
                        Headers / CDN
                    </h2>
                </div>
                <div id="headersResults" class="p-6"></div>
            </div>

            <!-- External Audits -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-profound-blue/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-external-link-alt text-profound-blue"></i>
                        External Audits
                    </h2>
                </div>
                <div id="externalResults" class="p-6"></div>
            </div>
            
            <!-- AI Readiness -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-warning/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-robot text-warning"></i>
                        AI / Generative Optimisation
                    </h2>
                </div>
                <div id="aiResults" class="p-6"></div>
                <div id="aiSurfacesResults" class="p-6 pt-0"></div>
            </div>

            <!-- Multi-Bot Analysis -->
            <div id="multiBotSection" class="hidden glass-card rounded-2xl overflow-hidden">
                <div class="bg-profound-blue/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-robot text-profound-blue"></i>
                        Multi-Bot Access Analysis
                        <span class="ml-2 px-2 py-1 bg-warning text-black text-xs rounded-full font-bold">PREMIUM</span>
                    </h2>
                    <p class="text-sm text-gray-400 mt-1">Comprehensive analysis of AI crawler access policies</p>
                </div>
                <div id="multiBotResults" class="p-6"></div>
            </div>

            <!-- Answer Engine Optimization (AEO) -->
            <div id="aeoSection" class="hidden glass-card rounded-2xl overflow-hidden">
                <div class="bg-warning/10 border-b border-profound-border px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-search-plus text-warning"></i>
                        Answer Engine Optimization (AEO)
                    </h2>
                </div>
                <div id="aeoResults" class="p-6"></div>
            </div>
            
            <!-- Priority Action Plan -->
            <div id="priorityFixesContainer" class="glass-card rounded-2xl p-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold mb-4">Priority Action Plan</h2>
                    <p class="text-gray-400">Fix what matters most. Ignore the noise.</p>
                </div>
                <div id="priorityFixesList">
                    <!-- Priority fixes will be populated here -->
                </div>
            </div>

            <!-- Google Attention -->
            <div class="bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-violet-600/20 to-purple-600/20 px-6 py-4 border-b border-gray-800">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <span class="text-2xl">🔍</span>
                        Google Attention — Google isn't psychic. Tell it who you are.
                    </h2>
                </div>
                <div id="seoResults" class="p-6"></div>
            </div>
            
            <!-- Raw Data (Debug) -->
            <details class="bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden">
                <summary class="px-6 py-4 cursor-pointer hover:bg-gray-800/50">
                    <i class="fas fa-bug mr-2"></i>Raw Data (Debug)
                </summary>
                <div class="p-6">
                    <pre id="rawData" class="text-xs text-gray-400"></pre>
                </div>
            </details>

            <!-- Sitemap Results -->
            <div id="sitemapResultsSection" class="hidden bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-600/20 to-emerald-600/20 px-6 py-4 border-b border-gray-800 flex items-center justify-between">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-sitemap"></i>
                        Sitemap Analysis Results
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="exportSitemapCsv()" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm">
                            <i class="fas fa-file-csv mr-1"></i>Export CSV
                        </button>
                        <button onclick="showSchemaRecommendations()" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm">
                            <i class="fas fa-lightbulb mr-1"></i>Schema Fixes
                        </button>
                    </div>
                </div>
                <div class="p-6" id="sitemapResults"></div>
                <div class="p-6 hidden" id="schemaRecommendations"></div>
            </div>

            <!-- Batch Results -->
            <div id="batchResultsSection" class="hidden bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-violet-600/20 to-purple-600/20 px-6 py-4 border-b border-gray-800 flex items-center justify-between">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-layer-group"></i>
                        Batch Results
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="exportBatchCsv()" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm">
                            <i class="fas fa-file-csv mr-1"></i>Export CSV
                        </button>
                        <button onclick="showBatchChecklist()" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm">
                            <i class="fas fa-list-check mr-1"></i>Fix next
                        </button>
                    </div>
                </div>
                <div class="p-6" id="batchResults"></div>
                <div class="p-6 hidden" id="batchChecklist"></div>
            </div>
            
            <!-- Fix Priorities -->
            <div id="fixPrioritiesSection" class="hidden bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-red-600/20 to-orange-600/20 px-6 py-4 border-b border-gray-800 flex items-center justify-between">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        Fix Priorities (Agency View)
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="exportPrioritiesCsv()" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm">
                            <i class="fas fa-file-csv mr-1"></i>Client Report
                        </button>
                        <button onclick="generateActionPlan()" class="px-4 py-2 bg-red-600 rounded hover:bg-red-700 text-sm">
                            <i class="fas fa-tasks mr-1"></i>Action Plan
                        </button>
                    </div>
                </div>
                <div class="p-6" id="fixPriorities"></div>
            </div>

            <!-- Actions -->
            <div class="flex gap-4 justify-center">
                <button onclick="showFixPriorities()" class="px-6 py-3 bg-gradient-to-r from-red-600 to-orange-600 rounded-lg hover:from-red-700 hover:to-orange-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-list-ol"></i>
                    Fix Priorities
                </button>
                <button onclick="exportCsvReport()" class="px-6 py-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-file-csv"></i>
                    Export CSV
                </button>
                <button onclick="exportFullReport()" class="px-6 py-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-download"></i>
                    Export Full Report
                </button>
                <button onclick="resetTool()" class="px-6 py-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-redo"></i>
                    New Analysis
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Use Cloud Run backend for production, localhost for development
        const BACKEND_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8080'  // Local development
            : 'https://seo-audit-backend-458683085682.us-central1.run.app';  // Optimized Cloud Run backend
        let currentResults = null;
        let components = null;
        
        // Initialize component library
        window.addEventListener('load', function() {
            try {
                // Ensure AttentionComponents class is available
                if (typeof AttentionComponents !== 'undefined') {
                    try {
                        components = new AttentionComponents();
                        if (components && typeof components.initializeCollapsibles === 'function') {
                            components.initializeCollapsibles();
                        }
                        console.log('AttentionComponents initialized successfully');
                    } catch (error) {
                        console.error('Error initializing AttentionComponents:', error);
                        components = null;
                    }
                } else {
                    console.warn('AttentionComponents class not found - using fallback mode');
                    components = null;
                }
                
                // Initialize server status check
                checkServerStatus();
            } catch (error) {
                console.error('Error in window load event:', error);
                // Fallback: ensure basic functionality works
                components = null;
                checkServerStatus();
            }
        });
        
        // Enhanced display functions using components
        function renderExecutiveSummary(auditResults) {
            try {
                if (!auditResults || typeof auditResults !== 'object' || !auditResults.tests) {
                    console.warn('Executive summary: Missing or invalid audit data', auditResults);
                    renderExecutiveSummaryFallback({});
                    return;
                }
                
                // Always use new attention system (skip old components)
                console.log('Using new Attention system rendering');
                renderExecutiveSummaryFallback(auditResults);
                return;
                
                const attentionScores = calculateAttentionScores(auditResults);
            
                // Update overall score display
                const overallScoreElement = document.getElementById('overallScore');
                if (overallScoreElement) {
                    overallScoreElement.textContent = attentionScores.overall;
                }
                
                // Helper function to get witty taglines
                function getAttentionTagline(score, type) {
                    if (type === 'user') {
                        if (score >= 85) return "Fast enough, mostly accessible — though not quite a UX utopia.";
                        if (score >= 70) return "Users won't rage quit immediately. That's something.";
                        if (score >= 50) return "Loading... still loading... users are getting impatient.";
                        return "Users are leaving faster than they arrived.";
                    } else if (type === 'google') {
                        if (score >= 90) return "Google can read you perfectly. Still might not rank you.";
                        if (score >= 80) return "Google can read you, but that doesn't mean it likes you.";
                        if (score >= 60) return "Google squints at your site and shrugs.";
                        return "Google pretends your site doesn't exist.";
                    } else if (type === 'ai') {
                        if (score >= 80) return "Robots love your content more than most humans do.";
                        if (score >= 65) return "AI skimmed your page and found it... adequate.";
                        if (score >= 40) return "The robots skimmed your page, shrugged, and moved on.";
                        return "AI took one look and immediately regretted its life choices.";
                    }
                    return "Needs attention.";
                }
                
                // Create the 3 attention cards
                const attentionCards = [
                    {
                        title: 'User Attention',
                        score: attentionScores.userAttention,
                        tagline: getAttentionTagline(attentionScores.userAttention, 'user'),
                        description: 'if people leave, robots don\'t matter.',
                        icon: '👥'
                    },
                    {
                        title: 'Google Attention', 
                        score: attentionScores.googleAttention,
                        tagline: getAttentionTagline(attentionScores.googleAttention, 'google'),
                        description: 'Google isn\'t psychic. Tell it who you are.',
                        icon: '🔍'
                    },
                    {
                        title: 'AI Attention',
                        score: attentionScores.aiAttention,
                        tagline: getAttentionTagline(attentionScores.aiAttention, 'ai'),
                        description: 'Robots don\'t read between the lines. They barely read the lines.',
                        icon: '🤖'
                    }
                ];
                
                // Render attention cards with horizontal scroll
                const cardsHtml = attentionCards.map(card => {
                    const scoreColor = card.score >= 80 ? 'text-success' : 
                                     card.score >= 60 ? 'text-warning' : 'text-danger';
                    const bgColor = card.score >= 80 ? 'bg-success/10' : 
                                   card.score >= 60 ? 'bg-warning/10' : 'bg-danger/10';
                    
                    return `
                        <div class="attention-card glass-card rounded-xl p-6 ${bgColor}">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center gap-2">
                                        <span class="text-2xl">${card.icon}</span>
                                        ${card.title}
                                    </h3>
                                    <p class="text-sm text-gray-400 mt-1">${card.description}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold ${scoreColor}">${card.score}/100</div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-300 italic">
                                "${card.tagline}"
                            </p>
                        </div>
                    `;
                }).join('');
                
                const executiveMetricsElement = document.getElementById('executiveMetrics');
                if (executiveMetricsElement) {
                    executiveMetricsElement.innerHTML = `
                        <div class="attention-cards">
                            ${cardsHtml}
                        </div>
                    `;
                }
            
                // Business insights - only render if we have actual data
                const businessImpact = extractBusinessImpacts(auditResults);
                const quickWins = extractQuickWins(auditResults);
                
                const businessInsightsElement = document.getElementById('businessInsights');
                if (businessInsightsElement) {
                    // Only show business insights if we have actual data (not loading states)
                    const hasBusinessImpact = Array.isArray(businessImpact) && businessImpact.length > 0 && 
                        !businessImpact.some(item => !item || item.includes('Loading') || item.includes('Analyzing'));
                    const hasQuickWins = Array.isArray(quickWins) && quickWins.length > 0 && 
                        !quickWins.some(item => !item || item.includes('Loading') || item.includes('Analyzing'));
                    
                    if (hasBusinessImpact || hasQuickWins) {
                        businessInsightsElement.innerHTML = `
                            ${hasBusinessImpact ? `
                                <div class="business-impact rounded-xl p-6">
                                    <h3 class="font-semibold text-success mb-3 flex items-center">
                                        <i class="fas fa-chart-line mr-2"></i>
                                        Business Impact
                                    </h3>
                                    <ul class="space-y-2 text-sm text-gray-300">
                                        ${businessImpact.map(item => `<li>• ${item}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${hasQuickWins ? `
                                <div class="glass-card rounded-xl p-6">
                                    <h3 class="font-semibold text-profound-blue mb-3 flex items-center">
                                        <i class="fas fa-code mr-2"></i>
                                        Quick Wins Available
                                    </h3>
                                    <ul class="space-y-2 text-sm text-gray-300">
                                        ${quickWins.map(item => `<li>• ${item}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        `;
                    } else {
                        // Hide the business insights section entirely if no data
                        businessInsightsElement.innerHTML = '';
                    }
                }
            } catch (error) {
                console.error('Error in renderExecutiveSummary:', error);
                renderExecutiveSummaryFallback(auditResults || {});
            }
        }
        
        // Fallback rendering function - also uses new attention system
        function renderExecutiveSummaryFallback(auditResults) {
            try {
                const attentionScores = calculateAttentionScores(auditResults || {});
                
                const overallScoreElement = document.getElementById('overallScore');
                if (overallScoreElement) {
                    overallScoreElement.textContent = attentionScores.overall;
                }
                
                // Helper function to get witty taglines (duplicate from main function)
                function getAttentionTagline(score, type) {
                    if (type === 'user') {
                        if (score >= 85) return "Fast enough, mostly accessible — though not quite a UX utopia.";
                        if (score >= 70) return "Users won't rage quit immediately. That's something.";
                        if (score >= 50) return "Loading... still loading... users are getting impatient.";
                        return "Users are leaving faster than they arrived.";
                    } else if (type === 'google') {
                        if (score >= 90) return "Google can read you perfectly. Still might not rank you.";
                        if (score >= 80) return "Google can read you, but that doesn't mean it likes you.";
                        if (score >= 60) return "Google squints at your site and shrugs.";
                        return "Google pretends your site doesn't exist.";
                    } else if (type === 'ai') {
                        if (score >= 80) return "Robots love your content more than most humans do.";
                        if (score >= 65) return "AI skimmed your page and found it... adequate.";
                        if (score >= 40) return "The robots skimmed your page, shrugged, and moved on.";
                        return "AI took one look and immediately regretted its life choices.";
                    }
                    return "Needs attention.";
                }
                
                // Create the 3 attention cards (same as main function)
                const attentionCards = [
                    {
                        title: 'User Attention',
                        score: attentionScores.userAttention,
                        tagline: getAttentionTagline(attentionScores.userAttention, 'user'),
                        description: 'if people leave, robots don\'t matter.',
                        icon: '👥'
                    },
                    {
                        title: 'Google Attention', 
                        score: attentionScores.googleAttention,
                        tagline: getAttentionTagline(attentionScores.googleAttention, 'google'),
                        description: 'Google isn\'t psychic. Tell it who you are.',
                        icon: '🔍'
                    },
                    {
                        title: 'AI Attention',
                        score: attentionScores.aiAttention,
                        tagline: getAttentionTagline(attentionScores.aiAttention, 'ai'),
                        description: 'Robots don\'t read between the lines. They barely read the lines.',
                        icon: '🤖'
                    }
                ];
                
                // Render attention cards
                const cardsHtml = attentionCards.map(card => {
                    const scoreColor = card.score >= 80 ? 'text-success' : 
                                     card.score >= 60 ? 'text-warning' : 'text-danger';
                    const bgColor = card.score >= 80 ? 'bg-success/10' : 
                                   card.score >= 60 ? 'bg-warning/10' : 'bg-danger/10';
                    
                    return `
                        <div class="attention-card glass-card rounded-xl p-6 ${bgColor}">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold flex items-center gap-2">
                                        <span class="text-2xl">${card.icon}</span>
                                        ${card.title}
                                    </h3>
                                    <p class="text-sm text-gray-400 mt-1">${card.description}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold ${scoreColor}">${card.score}/100</div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-300 italic">
                                "${card.tagline}"
                            </p>
                        </div>
                    `;
                }).join('');
                
                const executiveMetricsElement = document.getElementById('executiveMetrics');
                if (executiveMetricsElement) {
                    executiveMetricsElement.innerHTML = `
                        <div class="attention-cards">
                            ${cardsHtml}
                        </div>
                    `;
                }
                
                const businessInsightsElement = document.getElementById('businessInsights');
                if (businessInsightsElement) {
                    // Don't show loading placeholder - just hide the section if no data
                    businessInsightsElement.innerHTML = '';
                }
            } catch (error) {
                console.error('Error in renderExecutiveSummaryFallback:', error);
            }
        }
        
        function renderPriorityFixes(auditResults) {
            try {
                if (!components || typeof components.createPriorityFix !== 'function') {
                    console.warn('Priority fixes: Missing components or createPriorityFix function');
                    return;
                }
                
                if (!auditResults || typeof auditResults !== 'object' || !auditResults.tests) {
                    console.warn('Priority fixes: Missing or invalid audit data', auditResults);
                    return;
                }
                
                const priorities = calculateFixPriorities(auditResults);
                const topFixes = [...(priorities.critical || []), ...(priorities.high || []), ...(priorities.medium || [])].slice(0, 3);
                
                const priorityFixesListElement = document.getElementById('priorityFixesList');
                if (!priorityFixesListElement) {
                    console.warn('Priority fixes: Missing priorityFixesList element');
                    return;
                }
                
                if (topFixes.length === 0) {
                    priorityFixesListElement.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-success text-4xl mb-4"></i>
                            <h3 class="text-xl font-semibold text-success mb-2">Excellent Work!</h3>
                            <p class="text-gray-400">No critical issues found. Your site is in great shape!</p>
                        </div>
                    `;
                    return;
                }
                
                const fixesHtml = topFixes.map((fix, index) => {
                    try {
                        return components.createPriorityFix({
                            number: index + 1,
                            title: (fix && fix.issue) ? (fix.issue.split('.')[0] || fix.issue) : 'Issue detected',
                            description: `→ ${(fix && fix.impact) ? fix.impact.toLowerCase() : 'impact analysis'}`,
                            impact: (fix && fix.impact) || 'Performance improvement',
                            aiBenefit: extractAIBenefit(fix || {}),
                            effort: `${(fix && fix.effort) || 'Medium'} | ${(fix && fix.timeEstimate) || '1-2 hours'}`
                        });
                    } catch (error) {
                        console.warn('Error creating priority fix:', error, fix);
                        return '<div class="bg-gray-800/30 rounded-lg p-4"><div class="text-gray-500">Loading fix...</div></div>';
                    }
                }).join('');
                
                priorityFixesListElement.innerHTML = `<div class="space-y-6">${fixesHtml}</div>`;
            } catch (error) {
                console.error('Error in renderPriorityFixes:', error);
                const priorityFixesListElement = document.getElementById('priorityFixesList');
                if (priorityFixesListElement) {
                    priorityFixesListElement.innerHTML = `
                        <div class="text-center py-8 bg-gray-800/30 rounded-lg">
                            <p class="text-gray-400">Priority fixes loading...</p>
                        </div>
                    `;
                }
            }
        }
        
        // Helper functions for the new Attention scoring system
        function calculateAttentionScores(auditResults) {
            if (!auditResults || !auditResults.tests) {
                return { userAttention: 0, googleAttention: 0, aiAttention: 0, overall: 0 };
            }
            
            // User Attention = (Performance + Accessibility) / 2
            const userAttention = calculateUserAttentionScore(auditResults);
            
            // Google Attention = (SEO + Schema) / 2  
            const googleAttention = calculateGoogleAttentionScore(auditResults);
            
            // AI Attention = current AI scores
            const aiAttention = calculateAIAttentionScore(auditResults);
            
            // Overall = average of the 3 attention scores
            const overall = Math.round((userAttention + googleAttention + aiAttention) / 3);
            
            console.log('Attention Scores:', { userAttention, googleAttention, aiAttention, overall });
            
            return { userAttention, googleAttention, aiAttention, overall };
        }
        
        function calculateUserAttentionScore(auditResults) {
            let perfScore = 0;
            let a11yScore = 0;
            
            // Performance score
            if (auditResults.tests.performance?.scores?.overall) {
                const overall = auditResults.tests.performance.scores.overall;
                if (overall === 'good') perfScore = 90;
                else if (overall === 'needs-improvement') perfScore = 70;
                else if (overall === 'poor') perfScore = 50;
                else perfScore = 50;
            } else if (auditResults.tests.performance?.metrics) {
                const metrics = auditResults.tests.performance.metrics;
                if (metrics.firstContentfulPaint && metrics.loadComplete) {
                    let scoreSum = 0;
                    let scoreCount = 0;
                    
                    if (metrics.firstContentfulPaint < 1800) scoreSum += 90;
                    else if (metrics.firstContentfulPaint < 3000) scoreSum += 70;
                    else scoreSum += 50;
                    scoreCount++;
                    
                    if (metrics.loadComplete < 3000) scoreSum += 90;
                    else if (metrics.loadComplete < 5000) scoreSum += 70;
                    else scoreSum += 50;
                    scoreCount++;
                    
                    perfScore = scoreCount > 0 ? Math.round(scoreSum / scoreCount) : 50;
                }
            } else {
                perfScore = 50;
            }
            
            // Accessibility score
            if (typeof auditResults.tests.accessibility?.score === 'number') {
                a11yScore = auditResults.tests.accessibility.score;
            } else if (typeof auditResults.tests.accessibility?.score === 'string') {
                const score = auditResults.tests.accessibility.score;
                if (score === 'good') a11yScore = 90;
                else if (score === 'needs-improvement') a11yScore = 70;
                else if (score === 'poor') a11yScore = 50;
                else a11yScore = 50;
            } else {
                a11yScore = 50;
            }
            
            return Math.round((perfScore + a11yScore) / 2);
        }
        
        function calculateGoogleAttentionScore(auditResults) {
            const seoScore = calculateSEOScore(auditResults);
            const schemaScore = auditResults.tests.schema?.score || 0;
            
            return Math.round((seoScore + schemaScore) / 2);
        }
        
        function calculateAIAttentionScore(auditResults) {
            return auditResults.tests.aiSurfaces?.score || 
                   auditResults.tests.ai?.aiSurfacesReadiness?.overallScore ||
                   auditResults.tests.aiAdvanced?.overallScore || 
                   0;
        }
        
        // Legacy function for compatibility
        function calculateOverallScore(auditResults) {
            const scores = calculateAttentionScores(auditResults);
            return scores.overall;
        }
        
        function calculateSEOScore(auditResults) {
            if (!auditResults || !auditResults.tests) {
                return 0;
            }
            
            let seoScore = 100;
            if (auditResults.tests.metadata?.issues && Array.isArray(auditResults.tests.metadata.issues)) {
                seoScore -= auditResults.tests.metadata.issues.length * 5;
            }
            if (!auditResults.tests.files?.robots?.exists) seoScore -= 10;
            if (!auditResults.tests.files?.sitemap?.exists) seoScore -= 10;
            return Math.max(0, seoScore);
        }
        
        function getScoreStatus(score) {
            if (score >= 80) return 'good';
            if (score >= 60) return 'warning';
            return 'danger';
        }
        
        function calculateUserExperienceScore(auditResults) {
            if (!auditResults || !auditResults.tests) {
                return 0;
            }
            
            let totalScore = 0;
            let count = 0;
            
            // Performance component
            if (auditResults.tests.performance) {
                let perfScore = 0;
                
                if (auditResults.tests.performance.scores && auditResults.tests.performance.scores.overall) {
                    const overall = auditResults.tests.performance.scores.overall;
                    if (overall === 'good') perfScore = 90;
                    else if (overall === 'needs-improvement') perfScore = 70;
                    else perfScore = 50;
                } else if (auditResults.tests.performance.score) {
                    const score = auditResults.tests.performance.score;
                    if (typeof score === 'object') {
                        if (score.fcp === 'good' && score.loadTime === 'good') perfScore = 90;
                        else if (score.fcp !== 'poor' && score.loadTime !== 'poor') perfScore = 70;
                        else perfScore = 50;
                    } else {
                        perfScore = score;
                    }
                }
                
                if (perfScore > 0) {
                    totalScore += perfScore;
                    count++;
                }
            }
            
            // Accessibility component
            if (auditResults.tests.accessibility) {
                let a11yScore = 100;
                
                // Deduct points for issues
                if (auditResults.tests.accessibility.issues && Array.isArray(auditResults.tests.accessibility.issues)) {
                    const issueCount = auditResults.tests.accessibility.issues.length;
                    a11yScore -= (issueCount * 10); // 10 points per issue
                }
                
                // Ensure minimum score
                a11yScore = Math.max(0, a11yScore);
                
                if (a11yScore >= 0) {
                    totalScore += a11yScore;
                    count++;
                }
            }
            
            return count > 0 ? Math.round(totalScore / count) : 0;
        }
        
        function extractBusinessImpacts(auditResults) {
            const impacts = [];
            
            // Null safety check for auditResults and nested properties
            if (!auditResults || !auditResults.tests) {
                impacts.push('Analysis in progress...');
                return impacts;
            }
            
            if (auditResults.tests.accessibility?.score >= 80) {
                impacts.push('+12% user retention potential');
            }
            
            if (auditResults.tests.schema?.types && auditResults.tests.schema.types.length > 0) {
                impacts.push('3x more snippet inclusion');
            }
            
            if (auditResults.tests.ai || auditResults.tests.aiSurfaces) {
                impacts.push('Ahead of 95% of competitors');
            }
            
            if (impacts.length === 0) {
                impacts.push('Solid foundation for growth');
            }
            
            return impacts;
        }
        
        function extractQuickWins(auditResults) {
            const quickWins = [];
            
            // Null safety check for auditResults and nested properties
            if (!auditResults || !auditResults.tests) {
                quickWins.push('Analysis in progress...');
                return quickWins;
            }
            
            if (auditResults.tests.accessibility?.issues && Array.isArray(auditResults.tests.accessibility.issues)) {
                const imageIssues = auditResults.tests.accessibility.issues.filter(issue => 
                    issue.includes('image') || issue.includes('alt')
                ).length;
                if (imageIssues > 0) {
                    quickWins.push(`${imageIssues} images need alt text (2-3 hours)`);
                }
            }
            
            if (auditResults.tests.schema?.types && Array.isArray(auditResults.tests.schema.types)) {
                if (!auditResults.tests.schema.types.some(type => type.includes('FAQ'))) {
                    quickWins.push('Add FAQ schema (4-6 hours)');
                }
            } else {
                quickWins.push('Add FAQ schema (4-6 hours)');
            }
            
            if (!auditResults.tests.files?.llms?.exists) {
                quickWins.push('Create llms.txt (1 hour)');
            }
            
            if (quickWins.length === 0) {
                quickWins.push('Focus on content optimization');
            }
            
            return quickWins;
        }
        
        function extractAIBenefit(fix) {
            try {
                if (!fix || typeof fix !== 'object' || !fix.issue) {
                    return 'Improved AI visibility';
                }
                
                const issue = fix.issue.toLowerCase();
                if (issue.includes('alt text') || issue.includes('image')) {
                    return 'Images become quotable';
                }
                if (issue.includes('schema') || issue.includes('faq')) {
                    return 'Direct voice search answers';
                }
                if (issue.includes('llms.txt')) {
                    return 'Better crawler understanding';
                }
                return 'Improved AI visibility';
            } catch (error) {
                console.warn('Error in extractAIBenefit:', error, fix);
                return 'Improved AI visibility';
            }
        }
        
        // Priority fixes calculation function
        function calculateFixPriorities(auditResults) {
            const priorities = {
                critical: [],
                high: [],
                medium: [],
                low: []
            };
            
            try {
                // Null safety check
                if (!auditResults || typeof auditResults !== 'object' || !auditResults.tests) {
                    return priorities;
                }
                
                const tests = auditResults.tests;
                
                // Critical issues
                if (!tests.metadata || !tests.metadata.title) {
                    priorities.critical.push({
                        issue: 'Missing meta title',
                        impact: 'Essential for SEO ranking',
                        effort: 'Easy',
                        timeEstimate: '5 minutes'
                    });
                }
                
                if (!tests.metadata || !tests.metadata.description) {
                    priorities.critical.push({
                        issue: 'Missing meta description',
                        impact: 'Critical for search snippets',
                        effort: 'Easy',
                        timeEstimate: '10 minutes'
                    });
                }
            
                // High priority issues
                const imageCount = (tests.accessibility && tests.accessibility.heuristics && tests.accessibility.heuristics.images && tests.accessibility.heuristics.images.withoutAlt) ||
                                 (tests.accessibility && tests.accessibility.images && tests.accessibility.images.withoutAlt) || 0;
                if (imageCount > 0) {
                    priorities.high.push({
                        issue: `${imageCount} images missing alt text`,
                        impact: 'Accessibility compliance & AI understanding',
                        effort: 'Medium',
                        timeEstimate: '2-3 hours'
                    });
                }
                
                if (!tests.files || !tests.files.robots || !tests.files.robots.exists) {
                    priorities.high.push({
                        issue: 'Missing robots.txt file',
                        impact: 'Search engine crawling guidance',
                        effort: 'Easy',
                        timeEstimate: '15 minutes'
                    });
                }
                
                if (!tests.files || !tests.files.sitemap || !tests.files.sitemap.exists) {
                    priorities.high.push({
                        issue: 'Missing sitemap.xml file',
                        impact: 'Search engine indexing efficiency',
                        effort: 'Medium',
                        timeEstimate: '1 hour'
                    });
                }
            
                // Medium priority issues
                if (!tests.schema || !tests.schema.found) {
                    priorities.medium.push({
                        issue: 'Add structured data markup',
                        impact: 'Enhanced search snippets',
                        effort: 'Medium',
                        timeEstimate: '4-6 hours'
                    });
                }
                
                if (!tests.files || !tests.files.llms || !tests.files.llms.exists) {
                    priorities.medium.push({
                        issue: 'Create llms.txt for AI crawlers',
                        impact: 'AI search optimization',
                        effort: 'Easy',
                        timeEstimate: '1 hour'
                    });
                }
                
                const emptyLinks = (tests.accessibility && tests.accessibility.heuristics && tests.accessibility.heuristics.links && tests.accessibility.heuristics.links.empty) ||
                                 (tests.accessibility && tests.accessibility.links && tests.accessibility.links.empty) || 0;
                if (emptyLinks > 0) {
                    priorities.medium.push({
                        issue: `${emptyLinks} empty links found`,
                        impact: 'User experience & accessibility',
                        effort: 'Easy',
                        timeEstimate: '30 minutes'
                    });
                }
                
                return priorities;
            } catch (error) {
                console.error('Error in calculateFixPriorities:', error);
                return priorities;
            }
        }
        
        // Check server status on load
        async function checkServerStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    updateServerStatus('online', `Server online (cache: ${data.cache})`);
                    document.getElementById('auditBtn').disabled = false;
                } else {
                    updateServerStatus('offline', 'Server offline - Start backend first');
                    document.getElementById('auditBtn').disabled = true;
                }
            } catch (error) {
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const message = isLocal ? 'Backend not running - Run: npm start' : 'Backend temporarily unavailable - Please try again';
                updateServerStatus('offline', message);
                document.getElementById('auditBtn').disabled = true;
            }
        }
        
        function updateServerStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (status === 'online') {
                dot.classList.remove('bg-gray-500', 'bg-red-500');
                dot.classList.add('bg-green-500');
            } else {
                dot.classList.remove('bg-gray-500', 'bg-green-500');
                dot.classList.add('bg-red-500');
            }
            
            statusText.textContent = text;
        }
        
        async function startFullAudit() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            if (!url || !isValidUrl(url)) {
                alert('Please enter a valid URL');
                return;
            }
            
            const lhFlag = document.getElementById('lhCheckbox')?.checked;
            await runBackendAudit(url, lhFlag);
        }
        
        async function runBackendAudit(url, lhFlag) {
            const btn = document.getElementById('auditBtn');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            
            // UI State
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div><span>Analyzing...</span>';
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            
            document.getElementById('currentTest').innerHTML = 'Connecting to backend server...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/audit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url, lighthouse: lhFlag })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                currentResults = data;
                
                displayBackendResults(data);
                
            } catch (error) {
                console.error('Audit error:', error);
                alert(`Error: ${error.message}\n\nMake sure the backend server is running:\nnpm install && npm start`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i><span>Full Analysis</span>';
                progressSection.classList.add('hidden');
            }
        }

        // Batch audit (URLs separated by comma/newline)
        let batchResults = [];
        async function startBatchAudit() {
            const input = prompt('Enter URLs separated by comma or newline:');
            if (!input) return;
            const urls = input.split(/\s|,/).map(u => u.trim()).filter(Boolean);
            if (!urls.length) return;
            batchResults = [];
            document.getElementById('batchResultsSection').classList.remove('hidden');
            const container = document.getElementById('batchResults');
            container.innerHTML = '';
            for (const url of urls) {
                const row = document.createElement('div');
                row.className = 'test-result bg-gray-800/30 rounded-lg p-4 mb-2';
                row.innerHTML = `<div class="font-semibold mb-1">${url}</div><div class="text-sm text-gray-400">Running...</div>`;
                container.appendChild(row);
                try {
                    const r = await fetch(`${BACKEND_URL}/api/audit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url })});
                    const data = await r.json();
                    batchResults.push(data);
                    row.innerHTML = `<div class="font-semibold mb-1">${url}</div>` +
                        `<div class="text-sm text-gray-300">SEO: ${Math.max(0, (100 - (data.tests.metadata?.issues?.length || 0)*5 - (data.tests.files?.robots?.exists?0:10) - (data.tests.files?.sitemap?.exists?0:10)))}%, `+
                        `A11y: ${(data.tests.accessibility?.issues?.length||0)===0?'A':(data.tests.accessibility?.issues?.length||0)<=2?'B':'C'}, `+
                        `Perf: ${data.tests.performance?.score?.loadTime==='good' && data.tests.performance?.score?.fcp==='good' ? 'A' : 'B/C'}</div>`;
                } catch (e) {
                    row.innerHTML = `<div class="font-semibold mb-1">${url}</div><div class="text-sm text-red-400">Failed</div>`;
                }
            }
        }

        function exportBatchCsv() {
            if (!batchResults.length) return alert('No batch results');
            const headers = ['url','seoScore','a11yIssues','perfFCP','perfLoad','robots','sitemap'];
            const rows = [headers.join(',')];
            for (const r of batchResults) {
                const seo = Math.max(0, (100 - (r.tests.metadata?.issues?.length || 0)*5 - (r.tests.files?.robots?.exists?0:10) - (r.tests.files?.sitemap?.exists?0:10)));
                const a11y = (r.tests.accessibility?.issues?.length || 0);
                const fcp = r.tests.performance?.metrics?.firstContentfulPaint || '';
                const load = r.tests.performance?.metrics?.loadComplete || '';
                const robots = r.tests.files?.robots?.exists ? 'yes' : 'no';
                const sitemap = r.tests.files?.sitemap?.exists ? 'yes' : 'no';
                rows.push([r.url, seo, a11y, fcp, load, robots, sitemap].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `batch-audit-${Date.now()}.csv`;
            a.click();
        }

        function showBatchChecklist() {
            if (!batchResults.length) return alert('No batch results');
            const el = document.getElementById('batchChecklist');
            el.classList.remove('hidden');
            const items = batchResults.map(r => {
                const todo = [];
                if ((r.tests.metadata?.issues?.length || 0) > 0) todo.push('Fix meta title/description/canonical');
                if (!r.tests.files?.sitemap?.exists) todo.push('Add sitemap.xml and submit to GSC');
                if (!r.tests.files?.robots?.exists) todo.push('Add robots.txt with sitemap reference');
                if ((r.tests.accessibility?.heuristics?.images?.withoutAlt || r.tests.accessibility?.images?.withoutAlt || 0) > 0) todo.push('Add alt texts to images');
                if (r.tests.accessibility && (r.tests.accessibility.heuristics?.headings?.h1Count !== 1 || r.tests.accessibility.headings?.h1Count !== 1)) todo.push('Ensure single H1 per page');
                return { url: r.url, todo };
            });
            el.innerHTML = items.map(i => `
                <div class="test-result bg-gray-800/30 rounded p-3 mb-2">
                    <div class="font-semibold">${i.url}</div>
                    <ul class="text-sm text-gray-300 list-disc ml-5">${i.todo.map(t => `<li>${t}</li>`).join('')}</ul>
                </div>
            `).join('');
        }
        
        function displayBackendResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.remove('hidden');
            
            // **NEW: Render Executive Summary & Priority Fixes using components**
            renderExecutiveSummary(data);
            renderPriorityFixes(data);
            
            // Calculate scores
            let totalIssues = 0;
            let seoScore = 100;
            let perfScore = '-';
            let a11yScore = '-';
            
            // Performance score
            if (data.tests.performance?.scores) {
                const scores = data.tests.performance.scores;
                // Use the overall score if available, otherwise calculate from individual scores
                if (scores.overall) {
                    if (scores.overall === 'good') perfScore = 'A';
                    else if (scores.overall === 'needs-improvement') perfScore = 'B';
                    else perfScore = 'C';
                } else {
                    // Fallback: calculate from fcp and loadTime
                    const fcpGood = scores.fcp === 'good';
                    const loadGood = scores.loadTime === 'good';
                    if (fcpGood && loadGood) perfScore = 'A';
                    else if (fcpGood || loadGood) perfScore = 'B';
                    else perfScore = 'C';
                }
            } else if (data.tests.performance?.score) {
                // Legacy format support
                const score = data.tests.performance.score;
                if (score.loadTime === 'good' && score.fcp === 'good') perfScore = 'A';
                else if (score.loadTime !== 'poor' && score.fcp !== 'poor') perfScore = 'B';
                else perfScore = 'C';
            }
            
            // Accessibility score
            if (data.tests.accessibility?.issues) {
                const issues = data.tests.accessibility.issues.length;
                totalIssues += issues;
                if (issues === 0) a11yScore = 'A';
                else if (issues <= 2) a11yScore = 'B';
                else a11yScore = 'C';
            }
            
            // SEO Score calculation
            if (data.tests.metadata?.issues) {
                seoScore -= data.tests.metadata.issues.length * 5;
                totalIssues += data.tests.metadata.issues.length;
            }
            if (!data.tests.files?.robots?.exists) seoScore -= 10;
            if (!data.tests.files?.sitemap?.exists) seoScore -= 10;
            
            // Update overview cards
            document.getElementById('perfScore').textContent = perfScore;
            document.getElementById('perfScore').className = `text-2xl font-bold ${perfScore === 'A' ? 'status-good' : perfScore === 'B' ? 'status-warning' : 'status-error'}`;
            
            document.getElementById('a11yScore').textContent = a11yScore;
            document.getElementById('a11yScore').className = `text-2xl font-bold ${a11yScore === 'A' ? 'status-good' : a11yScore === 'B' ? 'status-warning' : 'status-error'}`;
            
            document.getElementById('seoScore').textContent = Math.max(0, seoScore) + '%';
            document.getElementById('seoScore').className = `text-2xl font-bold ${seoScore >= 80 ? 'status-good' : seoScore >= 60 ? 'status-warning' : 'status-error'}`;
            
            document.getElementById('issueCount').textContent = totalIssues;
            document.getElementById('issueCount').className = `text-2xl font-bold ${totalIssues === 0 ? 'status-good' : totalIssues <= 5 ? 'status-warning' : 'status-error'}`;
            
            // Display Schema results
            if (data.tests.schema) {
                const schemaHtml = renderSchemaResults(data.tests.schema);
                document.getElementById('schemaResults').innerHTML = schemaHtml;
            }
            
            // Display Metadata results
            if (data.tests.metadata) {
                const metaHtml = renderMetadataResults(data.tests.metadata);
                document.getElementById('metadataResults').innerHTML = metaHtml;
            }
            
            // Display Performance results
            if (data.tests.performance) {
                const perfHtml = renderPerformanceResults(data.tests.performance);
                document.getElementById('performanceResults').innerHTML = perfHtml;
            }
            
            // Display Accessibility results
            if (data.tests.accessibility) {
                const a11yHtml = renderAccessibilityResults(data.tests.accessibility);
                document.getElementById('accessibilityResults').innerHTML = a11yHtml;
            }
            
            // Display Files results
            if (data.tests.files) {
                const filesHtml = renderFilesResults(data.tests.files);
                document.getElementById('filesResults').innerHTML = filesHtml;
            }

            // Headers/CDN
            if (data.tests.headers) {
                const headersHtml = renderHeadersResults(data.tests.headers);
                document.getElementById('headersResults').innerHTML = headersHtml;
            }

            // External Audits
            if (data.tests.external) {
                const externalHtml = renderExternalResults(data.tests.external, data.tests.lighthouse);
                document.getElementById('externalResults').innerHTML = externalHtml;
            }
            
            // Display AI Advanced Analysis if available
            if (data.tests.aiAdvanced) {
                const aiAdvancedHtml = renderAIAdvancedResults(data.tests.aiAdvanced);
                document.getElementById('aiResults').innerHTML = aiAdvancedHtml;
            }
            
            // Display AI Readiness (additional AI tools)
            if (data.tests.ai) {
                const aiHtml = renderAIResults(data.tests.ai);
                document.getElementById('aiResults').innerHTML += aiHtml;
            }
            
            // Display Multi-Bot Analysis
            if (data.tests.multiBot) {
                const multiBotHtml = renderMultiBotResults(data.tests.multiBot);
                document.getElementById('multiBotResults').innerHTML = multiBotHtml;
                document.getElementById('multiBotSection').classList.remove('hidden');
            }
            // AI Surfaces data now routed to upper panel in renderAIResults()
            // if (data.tests.aiSurfaces) {
            //     const sHtml = renderAISurfaces(data.tests.aiSurfaces);
            //     document.getElementById('aiSurfacesResults').innerHTML = sHtml;
            // }

            // Display Answer Engine Optimization (AEO) results
            if (data.tests.aeo) {
                const aeoHtml = renderAEOResults(data.tests.aeo);
                document.getElementById('aeoResults').innerHTML = aeoHtml;
                document.getElementById('aeoSection').classList.remove('hidden');
            }

            // Display SEO results
            if (data.tests.seo) {
                const seoHtml = renderSEOResults(data.tests.seo);
                document.getElementById('seoResults').innerHTML = seoHtml;
            }
            
            // Raw data
            document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
        }
        
        function renderSchemaResults(schema) {
            let html = '<div class="space-y-4">';
            
            if (schema.found) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-check-circle status-good"></i>
                            <span class="font-semibold">Structured Data Found</span>
                        </div>
                        <div class="text-sm text-gray-400 space-y-1">
                            <p>• JSON-LD Scripts: ${schema.jsonLdCount}</p>
                            <p>• Has Microdata: ${schema.hasMicrodata ? 'Yes' : 'No'}</p>
                            <p>• Has RDFa: ${schema.hasRDFa ? 'Yes' : 'No'}</p>
                            ${schema.types.length > 0 ? `<p>• Types: ${schema.types.join(', ')}</p>` : ''}
                        </div>
                    </div>
                `;
                
                // Show validator links
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <div class="font-semibold mb-2">Validate with:</div>
                        <div class="flex gap-2">
                            <a href="https://search.google.com/test/rich-results" target="_blank" class="text-violet-400 hover:text-violet-300 text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>Google Rich Results
                            </a>
                            <a href="https://validator.schema.org/" target="_blank" class="text-violet-400 hover:text-violet-300 text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>Schema Validator
                            </a>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-exclamation-triangle status-warning"></i>
                            <span class="font-semibold">No Structured Data Found</span>
                        </div>
                        <p class="text-sm text-gray-400">Consider adding Schema.org markup for better SEO</p>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function renderMetadataResults(metadata) {
            let html = '<div class="space-y-4">';
            
            // Basic meta
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-4">
                    <h3 class="font-semibold mb-3">Basic Metadata</h3>
                    <div class="space-y-2 text-sm">
                        ${metadata.title ? `
                            <div class="flex justify-between">
                                <span class="text-gray-400">Title:</span>
                                <span class="text-white">${metadata.title.substring(0, 60)}${metadata.title.length > 60 ? '...' : ''}</span>
                            </div>
                        ` : '<div class="text-red-400">⚠ Title missing</div>'}
                        
                        ${metadata.description ? `
                            <div class="flex justify-between">
                                <span class="text-gray-400">Description:</span>
                                <span class="text-white">${metadata.description.substring(0, 50)}...</span>
                            </div>
                        ` : '<div class="text-red-400">⚠ Description missing</div>'}
                        
                        ${metadata.canonical ? `
                            <div class="flex justify-between">
                                <span class="text-gray-400">Canonical:</span>
                                <span class="text-green-400">✓ Set</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Open Graph
            if (metadata.og && Object.values(metadata.og).some(v => v)) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <h3 class="font-semibold mb-3">Open Graph</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            ${metadata.og.title ? '<div class="text-green-400">✓ Title</div>' : '<div class="text-gray-600">✗ Title</div>'}
                            ${metadata.og.description ? '<div class="text-green-400">✓ Description</div>' : '<div class="text-gray-600">✗ Description</div>'}
                            ${metadata.og.image ? '<div class="text-green-400">✓ Image</div>' : '<div class="text-gray-600">✗ Image</div>'}
                            ${metadata.og.url ? '<div class="text-green-400">✓ URL</div>' : '<div class="text-gray-600">✗ URL</div>'}
                        </div>
                    </div>
                `;
            }
            
            // Add witty SEO microcopy based on the creative director's plan
            const seoWittyIssues = [];
            
            // Canonical check
            if (metadata.canonical) {
                seoWittyIssues.push('• Canonical ✓ → No identity crisis here.');
            } else {
                seoWittyIssues.push('• Canonical ✗ → Google confused about which page is the real you.');
            }
            
            // Open Graph checks with humor
            if (metadata.og && metadata.og.title && metadata.og.description && metadata.og.image) {
                seoWittyIssues.push('• Open Graph ✓ → Social previews won\'t look like garbage.');
            } else {
                seoWittyIssues.push('• Open Graph ✗ → Social shares will look like spam from 2009.');
            }
            
            // Meta title/description checks
            if (!metadata.title) {
                seoWittyIssues.push('• Title tag ✗ → Even Google doesn\'t know what your page is about.');
            } else if (metadata.title.length > 60) {
                seoWittyIssues.push('• Title too long → Google will cut you off mid-sentence...');
            } else {
                seoWittyIssues.push('• Title tag ✓ → Google knows exactly who you are.');
            }
            
            if (!metadata.description) {
                seoWittyIssues.push('• Meta description ✗ → Your SERP snippet will be a random word salad.');
            } else if (metadata.description.length > 160) {
                seoWittyIssues.push('• Description too long → Google\'s gonna chop it like a bad haircut.');
            } else {
                seoWittyIssues.push('• Meta description ✓ → SERP snippets that actually make sense.');
            }
            
            // Display witty SEO feedback
            if (seoWittyIssues.length > 0) {
                html += `
                    <div class="test-result bg-blue-900/20 rounded-lg p-4 border border-blue-500/30">
                        <h3 class="font-semibold mb-3 text-blue-400">SEO Reality Check</h3>
                        <ul class="space-y-1 text-sm text-gray-300">
                            ${seoWittyIssues.join('<br>')}
                        </ul>
                    </div>
                `;
            }
            
            // Original issues (keep for technical stuff)
            if (metadata.issues && metadata.issues.length > 0) {
                html += `
                    <div class="test-result bg-red-900/20 rounded-lg p-4 mt-4">
                        <h3 class="font-semibold mb-3 text-red-400">Technical Issues</h3>
                        <ul class="space-y-1 text-sm text-gray-400">
                            ${metadata.issues.map(issue => `<li>• ${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function renderPerformanceResults(performance) {
            const metrics = performance.metrics || {};
            const scores = performance.scores || {};
            
            let html = '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
            
            // First Contentful Paint
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold ${metrics.firstContentfulPaint < 1800 ? 'status-good' : metrics.firstContentfulPaint < 3000 ? 'status-warning' : 'status-error'}">
                        ${Math.round(metrics.firstContentfulPaint || 0)}ms
                    </div>
                    <div class="text-xs text-gray-400 mt-1">First Contentful Paint</div>
                </div>
            `;
            
            // Load Time
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold ${metrics.loadComplete < 3000 ? 'status-good' : metrics.loadComplete < 5000 ? 'status-warning' : 'status-error'}">
                        ${(metrics.loadComplete / 1000).toFixed(1)}s
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Load Time</div>
                </div>
            `;
            
            // Resources - Fix the [object Object] issue
            const resourceCount = metrics.resources?.total || metrics.resources || 0;
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold ${resourceCount < 30 ? 'status-good' : resourceCount < 50 ? 'status-warning' : 'status-error'}">
                        ${resourceCount}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Resources</div>
                </div>
            `;
            
            // Memory - Fix display
            if (metrics.memory && metrics.memory.usedJSHeapSize) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold ${metrics.memory.usedJSHeapSize < 10 ? 'status-good' : metrics.memory.usedJSHeapSize < 20 ? 'status-warning' : 'status-error'}">
                            ${metrics.memory.usedJSHeapSize}MB
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Memory Used</div>
                    </div>
                `;
            } else {
                // Fallback for when memory data is not available
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-gray-500">
                            -
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Memory Used</div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Performance Score Summary
            if (scores && Object.keys(scores).length > 0) {
                html += `
                    <div class="mt-4 bg-gray-800/30 rounded-lg p-4">
                        <h4 class="font-semibold mb-3">Performance Scores</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            ${scores.fcp ? `
                                <div class="text-center">
                                    <div class="font-bold ${scores.fcp === 'good' ? 'text-green-400' : scores.fcp === 'needs-improvement' ? 'text-yellow-400' : 'text-red-400'}">
                                        ${scores.fcp === 'good' ? 'A' : scores.fcp === 'needs-improvement' ? 'B' : 'C'}
                                    </div>
                                    <div class="text-gray-400 text-xs">FCP</div>
                                </div>
                            ` : ''}
                            ${scores.loadTime ? `
                                <div class="text-center">
                                    <div class="font-bold ${scores.loadTime === 'good' ? 'text-green-400' : scores.loadTime === 'needs-improvement' ? 'text-yellow-400' : 'text-red-400'}">
                                        ${scores.loadTime === 'good' ? 'A' : scores.loadTime === 'needs-improvement' ? 'B' : 'C'}
                                    </div>
                                    <div class="text-gray-400 text-xs">Load Time</div>
                                </div>
                            ` : ''}
                            ${scores.domContentLoaded ? `
                                <div class="text-center">
                                    <div class="font-bold ${scores.domContentLoaded === 'good' ? 'text-green-400' : scores.domContentLoaded === 'needs-improvement' ? 'text-yellow-400' : 'text-red-400'}">
                                        ${scores.domContentLoaded === 'good' ? 'A' : scores.domContentLoaded === 'needs-improvement' ? 'B' : 'C'}
                                    </div>
                                    <div class="text-gray-400 text-xs">DOM Ready</div>
                                </div>
                            ` : ''}
                            ${scores.overall ? `
                                <div class="text-center">
                                    <div class="font-bold ${scores.overall === 'good' ? 'text-green-400' : scores.overall === 'needs-improvement' ? 'text-yellow-400' : 'text-red-400'}">
                                        ${scores.overall === 'good' ? 'A' : scores.overall === 'needs-improvement' ? 'B' : 'C'}
                                    </div>
                                    <div class="text-gray-400 text-xs">Overall</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Add witty performance microcopy
            const tips = [];
            if (metrics.firstContentfulPaint > 3000) {
                tips.push('• Loading so slow, users aged waiting for it');
            } else if (metrics.firstContentfulPaint > 1800) {
                tips.push('• First paint took its sweet time (aim for < 1.8s)');
            }
            
            if (metrics.loadComplete > 5000) {
                tips.push('• Page load time: "Are we there yet?" levels of frustration');
            } else if (metrics.loadComplete > 3000) {
                tips.push('• Load time giving users time for a coffee break (aim for < 3s)');
            }
            
            if (resourceCount > 100) {
                tips.push('• Resource count higher than most people\'s IQ');
            } else if (resourceCount > 50) {
                tips.push('• Lots of resources - your page is having a house party');
            }
            
            if (metrics.memory && metrics.memory.usedJSHeapSize > 50) {
                tips.push('• Memory usage: your page is a digital hoarder');
            } else if (metrics.memory && metrics.memory.usedJSHeapSize > 20) {
                tips.push('• Memory usage could use some Marie Kondo magic');
            }
            
            if (tips.length > 0) {
                html += `
                    <div class="mt-4 text-sm text-gray-400">
                        <p class="mb-2 font-medium text-warning">Performance Reality Check:</p>
                        <ul class="space-y-1">
                            ${tips.join('<br>')}
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="mt-4 text-sm text-success">
                        <p class="flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            <span>Speed demon! Users won't rage quit today.</span>
                        </p>
                    </div>
                `;
            }
            
            return html;
        }
        
        function renderAccessibilityResults(accessibility) {
            let html = '<div class="space-y-4">';
            
            // Use heuristics data if available, otherwise fallback to direct properties
            const images = accessibility.heuristics?.images || accessibility.images || { percentage: 0, withoutAlt: 0 };
            const headings = accessibility.heuristics?.headings || accessibility.headings || { h1Count: 0 };
            const links = accessibility.heuristics?.links || accessibility.links || { empty: 0 };
            const lang = accessibility.heuristics?.lang || accessibility.lang;
            
            // Stats grid
            html += `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="test-result bg-gray-800/30 rounded-lg p-3">
                        <div class="text-xl font-bold ${images.percentage === 0 ? 'status-good' : images.percentage < 20 ? 'status-warning' : 'status-error'}">
                            ${images.percentage || 0}%
                        </div>
                        <div class="text-xs text-gray-400">Images without alt</div>
                    </div>
                    
                    <div class="test-result bg-gray-800/30 rounded-lg p-3">
                        <div class="text-xl font-bold ${headings.h1Count === 1 ? 'status-good' : 'status-warning'}">
                            ${headings.h1Count || 0}
                        </div>
                        <div class="text-xs text-gray-400">H1 Tags</div>
                    </div>
                    
                    <div class="test-result bg-gray-800/30 rounded-lg p-3">
                        <div class="text-xl font-bold ${links.empty === 0 ? 'status-good' : 'status-error'}">
                            ${links.empty || 0}
                        </div>
                        <div class="text-xs text-gray-400">Empty Links</div>
                    </div>
                    
                    <div class="test-result bg-gray-800/30 rounded-lg p-3">
                        <div class="text-xl font-bold ${lang ? 'status-good' : 'status-error'}">
                            ${lang || 'Missing'}
                        </div>
                        <div class="text-xs text-gray-400">Language</div>
                    </div>
                </div>
            `;
            
            // Add witty accessibility microcopy for common issues
            const wittyIssues = [];
            
            if (images.withoutAlt > 0) {
                if (images.withoutAlt > 50) {
                    wittyIssues.push(`${images.withoutAlt} images missing alt text → AI sees nothing, users see... also nothing.`);
                } else if (images.withoutAlt > 10) {
                    wittyIssues.push(`${images.withoutAlt} images without alt text → mystery images for screen readers.`);
                } else {
                    wittyIssues.push(`${images.withoutAlt} images missing alt text → what are they hiding?`);
                }
            }
            
            if (links.empty > 0) {
                if (links.empty > 5) {
                    wittyIssues.push(`${links.empty} empty links → mystery buttons that go nowhere.`);
                } else {
                    wittyIssues.push(`${links.empty} empty links → broken promises in link form.`);
                }
            }
            
            if (!lang) {
                wittyIssues.push('Page language not specified → Google assumes you speak alien.');
            }
            
            // Check for form inputs without labels (if available in data)
            const formsData = accessibility.heuristics?.forms || accessibility.forms;
            if (formsData?.inputsWithoutLabels > 0) {
                wittyIssues.push(`${formsData.inputsWithoutLabels} inputs without labels → guess the field, win a prize.`);
            }
            
            // Add original issues with less humor for serious stuff
            const otherIssues = accessibility.issues?.filter(issue => 
                !issue.includes('alt') && 
                !issue.includes('empty') && 
                !issue.includes('language') &&
                !issue.includes('label')
            ) || [];
            
            if (wittyIssues.length > 0 || otherIssues.length > 0) {
                html += `
                    <div class="test-result bg-yellow-900/20 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-yellow-400">Accessibility Reality Check</h3>
                        <ul class="space-y-1 text-sm text-gray-400">
                            ${wittyIssues.map(issue => `<li>• ${issue}</li>`).join('')}
                            ${otherIssues.map(issue => `<li>• ${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result bg-green-900/20 rounded-lg p-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle status-good"></i>
                            <span class="font-semibold text-green-400">Accessibility champion! Screen readers are happy.</span>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function renderFilesResults(files) {
            let html = '<div class="space-y-4">';
            
            // Add witty files microcopy section
            const filesWittyIssues = [];
            
            // Robots.txt with humor  
            if (files.robots?.exists) {
                filesWittyIssues.push('• robots.txt ✓ → Politely telling bots where they can and cannot go.');
            } else {
                filesWittyIssues.push('• robots.txt ✗ → Wild west for web crawlers. Anything goes.');
            }
            
            // Sitemap with humor
            if (files.sitemap?.exists) {
                filesWittyIssues.push('• sitemap.xml ✓ → A treasure map for search engines.');
            } else {
                filesWittyIssues.push('• sitemap.xml ✗ → Google playing hide-and-seek with your pages.');
            }
            
            // RSS with humor
            if (files.rss?.exists) {
                filesWittyIssues.push('• RSS feed ✓ → Welcome back to 2009! (But hey, some people still use it.)');
            } else {
                filesWittyIssues.push('• RSS ✗ → Optional. Unless you really miss 2009.');
            }
            
            // LLMS.txt with humor
            if (files.llms?.exists) {
                filesWittyIssues.push('• llms.txt ✓ → AI bots know exactly what they\'re allowed to train on.');
            } else {
                filesWittyIssues.push('• llms.txt ✗ → ChatGPT might be learning from your grocery list.');
            }
            
            // Display witty files feedback
            html += `
                <div class="test-result bg-purple-900/20 rounded-lg p-4 border border-purple-500/30">
                    <h3 class="font-semibold mb-3 text-purple-400">File Status Check</h3>
                    <ul class="space-y-1 text-sm text-gray-300">
                        ${filesWittyIssues.join('<br>')}
                    </ul>
                </div>
            `;
            
            // Technical details grid
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            // Robots.txt
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold">robots.txt</span>
                        <span class="${files.robots?.exists ? 'status-good' : 'status-warning'}">
                            ${files.robots?.exists ? '✓ Found' : '✗ Not Found'}
                        </span>
                    </div>
                    ${files.robots?.exists ? `
                        <div class="text-xs text-gray-400">
                            <p>• Has Sitemap ref: ${files.robots.hasSitemap ? 'Yes' : 'No'}</p>
                            <p>• Has User-agent: ${files.robots.hasUserAgent ? 'Yes' : 'No'}</p>
                        </div>
                    ` : '<p class="text-xs text-gray-400">Consider adding robots.txt for crawler control</p>'}
                </div>
            `;
            
            // Sitemap
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold">sitemap.xml</span>
                        <span class="${files.sitemap?.exists ? 'status-good' : 'status-warning'}">
                            ${files.sitemap?.exists ? '✓ Found' : '✗ Not Found'}
                        </span>
                    </div>
                    ${files.sitemap?.exists && files.sitemap.urlCount ? `
                        <div class="text-xs text-gray-400">
                            <p>• URLs indexed: ${files.sitemap.urlCount}</p>
                        </div>
                    ` : '<p class="text-xs text-gray-400">Sitemap helps search engines find all pages</p>'}
                </div>
            `;
            
            // RSS
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold">RSS Feed</span>
                        <span class="${files.rss?.exists ? 'status-good' : 'status-info'}">
                            ${files.rss?.exists ? '✓ Found' : '✗ Not Found'}
                        </span>
                    </div>
                    ${!files.rss?.exists ? '<p class="text-xs text-gray-400">Optional for most sites</p>' : ''}
                </div>
            `;
            
            // LLMS.txt
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold">llms.txt</span>
                        <span class="${files.llms?.exists ? 'status-good' : 'status-info'}">
                            ${files.llms?.exists ? '✓ Found' : '✗ Not Found'}
                        </span>
                    </div>
                    ${!files.llms?.exists ? `
                        <div class="text-xs text-gray-400">
                            <p>New standard for AI crawlers</p>
                            <a href="https://llmstxt.org/" target="_blank" class="text-violet-400 hover:text-violet-300">
                                <i class="fas fa-external-link-alt mr-1"></i>Learn more
                            </a>
                        </div>
                    ` : ''}
                </div>
            `;
            
            html += '</div>';
            return html;
        }
        
        function renderSEOResults(seo) {
            let html = '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
            
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-3">
                    <div class="text-xl font-bold ${seo.https ? 'status-good' : 'status-error'}">
                        ${seo.https ? 'HTTPS' : 'HTTP'}
                    </div>
                    <div class="text-xs text-gray-400">Protocol</div>
                </div>
                
                <div class="test-result bg-gray-800/30 rounded-lg p-3">
                    <div class="text-xl font-bold ${seo.h1 === 1 ? 'status-good' : seo.h1 === 0 ? 'status-error' : 'status-warning'}">
                        ${seo.h1}
                    </div>
                    <div class="text-xs text-gray-400">H1 Tags</div>
                </div>
                
                <div class="test-result bg-gray-800/30 rounded-lg p-3">
                    <div class="text-xl font-bold text-white">
                        ${seo.internalLinks}
                    </div>
                    <div class="text-xs text-gray-400">Internal Links</div>
                </div>
                
                <div class="test-result bg-gray-800/30 rounded-lg p-3">
                    <div class="text-xl font-bold text-white">
                        ${seo.wordCount}
                    </div>
                    <div class="text-xs text-gray-400">Word Count</div>
                </div>
            `;
            
            html += '</div>';
            
            // Social links
            if (seo.socialLinks) {
                html += `
                    <div class="mt-4 test-result bg-gray-800/30 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Social Media Presence</h3>
                        <div class="grid grid-cols-4 gap-2 text-sm">
                            <div class="${seo.socialLinks.facebook ? 'text-green-400' : 'text-gray-600'}">
                                <i class="fab fa-facebook mr-1"></i>
                                ${seo.socialLinks.facebook ? 'Found' : 'Not found'}
                            </div>
                            <div class="${seo.socialLinks.twitter ? 'text-green-400' : 'text-gray-600'}">
                                <i class="fab fa-twitter mr-1"></i>
                                ${seo.socialLinks.twitter ? 'Found' : 'Not found'}
                            </div>
                            <div class="${seo.socialLinks.linkedin ? 'text-green-400' : 'text-gray-600'}">
                                <i class="fab fa-linkedin mr-1"></i>
                                ${seo.socialLinks.linkedin ? 'Found' : 'Not found'}
                            </div>
                            <div class="${seo.socialLinks.instagram ? 'text-green-400' : 'text-gray-600'}">
                                <i class="fab fa-instagram mr-1"></i>
                                ${seo.socialLinks.instagram ? 'Found' : 'Not found'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        function renderHeadersResults(h) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="test-result bg-gray-800/30 rounded-lg p-3">
                        <div class="text-sm text-gray-400">CDN</div>
                        <div class="text-lg font-semibold">${h.cdn || 'Unknown'}</div>
                    </div>
                    <div class="test-result bg-gray-800/30 rounded-lg p-3">
                        <div class="text-sm text-gray-400">Cache</div>
                        <div class="text-lg font-semibold">${h.cacheStatus || '-'}</div>
                    </div>
                    <div class="test-result bg-gray-800/30 rounded-lg p-3">
                        <div class="text-sm text-gray-400">Server</div>
                        <div class="text-lg font-semibold">${h.server || '-'}</div>
                    </div>
                </div>
            `;
        }

        function renderExternalResults(ext, lighthouseData) {
            let html = '<div class="space-y-6">';
            
            // Enhanced Lighthouse Results Display
            if (lighthouseData && !lighthouseData.error) {
                html += `
                    <div class="test-result bg-gradient-to-r from-profound-blue/20 to-blue-900/20 rounded-xl p-6 border border-profound-blue/30">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-profound-blue flex items-center gap-2">
                                <i class="fas fa-lighthouse"></i>
                                Google Lighthouse Analysis
                            </h3>
                            <div class="text-xs text-gray-400">v12.0+</div>
                        </div>
                        
                        <!-- Lighthouse Scores Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-center p-4 bg-gray-800/50 rounded-lg">
                                <div class="text-3xl font-bold ${lighthouseData.scores?.performance >= 90 ? 'text-success' : lighthouseData.scores?.performance >= 50 ? 'text-warning' : 'text-danger'}">
                                    ${lighthouseData.scores?.performance ?? '-'}
                                </div>
                                <div class="text-sm text-gray-400 mt-1">Performance</div>
                            </div>
                            <div class="text-center p-4 bg-gray-800/50 rounded-lg">
                                <div class="text-3xl font-bold ${lighthouseData.scores?.accessibility >= 90 ? 'text-success' : lighthouseData.scores?.accessibility >= 50 ? 'text-warning' : 'text-danger'}">
                                    ${lighthouseData.scores?.accessibility ?? '-'}
                                </div>
                                <div class="text-sm text-gray-400 mt-1">Accessibility</div>
                            </div>
                            <div class="text-center p-4 bg-gray-800/50 rounded-lg">
                                <div class="text-3xl font-bold ${lighthouseData.scores?.seo >= 90 ? 'text-success' : lighthouseData.scores?.seo >= 50 ? 'text-warning' : 'text-danger'}">
                                    ${lighthouseData.scores?.seo ?? '-'}
                                </div>
                                <div class="text-sm text-gray-400 mt-1">SEO</div>
                            </div>
                            <div class="text-center p-4 bg-gray-800/50 rounded-lg">
                                <div class="text-3xl font-bold ${lighthouseData.scores?.bestPractices >= 90 ? 'text-success' : lighthouseData.scores?.bestPractices >= 50 ? 'text-warning' : 'text-danger'}">
                                    ${lighthouseData.scores?.bestPractices ?? '-'}
                                </div>
                                <div class="text-sm text-gray-400 mt-1">Best Practices</div>
                            </div>
                        </div>
                        
                        <!-- Core Web Vitals -->
                        ${lighthouseData.metrics ? `
                            <div class="mb-6">
                                <h4 class="font-semibold text-profound-blue mb-3 flex items-center gap-2">
                                    <i class="fas fa-tachometer-alt"></i> Core Web Vitals
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    ${lighthouseData.metrics.firstContentfulPaint ? `
                                        <div class="bg-gray-800/30 rounded-lg p-3 text-center">
                                            <div class="text-xl font-bold ${lighthouseData.metrics.firstContentfulPaint <= 1800 ? 'text-success' : lighthouseData.metrics.firstContentfulPaint <= 3000 ? 'text-warning' : 'text-danger'}">
                                                ${Math.round(lighthouseData.metrics.firstContentfulPaint)}ms
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">First Contentful Paint</div>
                                        </div>
                                    ` : ''}
                                    ${lighthouseData.metrics.largestContentfulPaint ? `
                                        <div class="bg-gray-800/30 rounded-lg p-3 text-center">
                                            <div class="text-xl font-bold ${lighthouseData.metrics.largestContentfulPaint <= 2500 ? 'text-success' : lighthouseData.metrics.largestContentfulPaint <= 4000 ? 'text-warning' : 'text-danger'}">
                                                ${Math.round(lighthouseData.metrics.largestContentfulPaint)}ms
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">Largest Contentful Paint</div>
                                        </div>
                                    ` : ''}
                                    ${lighthouseData.metrics.cumulativeLayoutShift !== null && lighthouseData.metrics.cumulativeLayoutShift !== undefined ? `
                                        <div class="bg-gray-800/30 rounded-lg p-3 text-center">
                                            <div class="text-xl font-bold ${lighthouseData.metrics.cumulativeLayoutShift <= 0.1 ? 'text-success' : lighthouseData.metrics.cumulativeLayoutShift <= 0.25 ? 'text-warning' : 'text-danger'}">
                                                ${lighthouseData.metrics.cumulativeLayoutShift.toFixed(3)}
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">Cumulative Layout Shift</div>
                                        </div>
                                    ` : ''}
                                    ${lighthouseData.metrics.totalBlockingTime ? `
                                        <div class="bg-gray-800/30 rounded-lg p-3 text-center">
                                            <div class="text-xl font-bold ${lighthouseData.metrics.totalBlockingTime <= 200 ? 'text-success' : lighthouseData.metrics.totalBlockingTime <= 600 ? 'text-warning' : 'text-danger'}">
                                                ${Math.round(lighthouseData.metrics.totalBlockingTime)}ms
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">Total Blocking Time</div>
                                        </div>
                                    ` : ''}
                                    ${lighthouseData.metrics.speedIndex ? `
                                        <div class="bg-gray-800/30 rounded-lg p-3 text-center">
                                            <div class="text-xl font-bold ${lighthouseData.metrics.speedIndex <= 3400 ? 'text-success' : lighthouseData.metrics.speedIndex <= 5800 ? 'text-warning' : 'text-danger'}">
                                                ${Math.round(lighthouseData.metrics.speedIndex)}ms
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">Speed Index</div>
                                        </div>
                                    ` : ''}
                                    ${lighthouseData.metrics.firstMeaningfulPaint ? `
                                        <div class="bg-gray-800/30 rounded-lg p-3 text-center">
                                            <div class="text-xl font-bold text-gray-300">
                                                ${Math.round(lighthouseData.metrics.firstMeaningfulPaint)}ms
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">First Meaningful Paint</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Top Opportunities -->
                        ${lighthouseData.opportunities && lighthouseData.opportunities.length > 0 ? `
                            <div class="mb-4">
                                <h4 class="font-semibold text-warning mb-3 flex items-center gap-2">
                                    <i class="fas fa-lightbulb"></i> Top Optimization Opportunities
                                </h4>
                                <div class="space-y-2">
                                    ${lighthouseData.opportunities.slice(0, 3).map(opp => `
                                        <div class="bg-gray-800/30 rounded-lg p-3 flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="font-medium text-sm text-white">${opp.title}</div>
                                                <div class="text-xs text-gray-400 mt-1">${opp.description}</div>
                                            </div>
                                            <div class="text-right text-xs">
                                                ${opp.savingsMs > 0 ? `<div class="text-warning font-medium">-${Math.round(opp.savingsMs)}ms</div>` : ''}
                                                ${opp.savingsBytes > 0 ? `<div class="text-gray-400">-${(opp.savingsBytes / 1024).toFixed(1)}KB</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (lighthouseData && lighthouseData.error) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4 border-l-4 border-danger">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                            <span class="font-semibold text-danger">Lighthouse Analysis Failed</span>
                        </div>
                        <div class="text-sm text-gray-300">${lighthouseData.error}</div>
                        <div class="text-xs text-gray-400 mt-2">💡 Try enabling the "Run Lighthouse" option and ensure Chrome is available</div>
                    </div>
                `;
            }
            
            // PageSpeed Insights
            if (ext.psi && !ext.psi.error) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-semibold flex items-center gap-2">
                                <i class="fas fa-google text-blue-400"></i>
                                PageSpeed Insights (Mobile)
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold ${ext.psi.score >= 90 ? 'text-success' : ext.psi.score >= 50 ? 'text-warning' : 'text-danger'}">
                                    ${ext.psi.score ?? '-'}
                                </div>
                            </div>
                        </div>
                        ${ext.psi.metrics ? `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                ${ext.psi.metrics.fcp ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${Math.round(ext.psi.metrics.fcp)}ms</div>
                                        <div class="text-xs text-gray-400">FCP</div>
                                    </div>
                                ` : ''}
                                ${ext.psi.metrics.lcp ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${Math.round(ext.psi.metrics.lcp)}ms</div>
                                        <div class="text-xs text-gray-400">LCP</div>
                                    </div>
                                ` : ''}
                                ${ext.psi.metrics.cls !== null && ext.psi.metrics.cls !== undefined ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${ext.psi.metrics.cls.toFixed(3)}</div>
                                        <div class="text-xs text-gray-400">CLS</div>
                                    </div>
                                ` : ''}
                                ${ext.psi.metrics.speedIndex ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${Math.round(ext.psi.metrics.speedIndex)}ms</div>
                                        <div class="text-xs text-gray-400">SI</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        <a class="text-profound-blue text-xs hover:underline" target="_blank" href="${ext.psi.link}">🔗 View Full PSI Report</a>
                    </div>
                `;
            } else if (ext.psi && ext.psi.error) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <div class="font-semibold mb-1 text-warning">PageSpeed Insights</div>
                        <div class="text-sm text-gray-300">Error: ${ext.psi.error}</div>
                        <div class="text-xs text-gray-400 mt-1">💡 Requires PSI_API_KEY environment variable</div>
                    </div>
                `;
            }
            
            // WebPageTest
            if (ext.wpt && !ext.wpt.error) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-semibold flex items-center gap-2">
                                <i class="fas fa-chart-line text-green-400"></i>
                                WebPageTest
                            </div>
                            <div class="text-xs px-2 py-1 rounded ${ext.wpt.status === 'triggered' ? 'bg-yellow-600' : 'bg-gray-600'} text-white">
                                ${ext.wpt.status || 'Unknown'}
                            </div>
                        </div>
                        ${ext.wpt.location ? `<div class="text-sm text-gray-400 mb-2">Location: ${ext.wpt.location}</div>` : ''}
                        ${ext.wptMetrics && ext.wptMetrics.status === 'complete' ? `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                ${ext.wptMetrics.metrics.ttfb ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${ext.wptMetrics.metrics.ttfb}ms</div>
                                        <div class="text-xs text-gray-400">TTFB</div>
                                    </div>
                                ` : ''}
                                ${ext.wptMetrics.metrics.fcp ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${ext.wptMetrics.metrics.fcp}ms</div>
                                        <div class="text-xs text-gray-400">FCP</div>
                                    </div>
                                ` : ''}
                                ${ext.wptMetrics.metrics.lcp ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${ext.wptMetrics.metrics.lcp}ms</div>
                                        <div class="text-xs text-gray-400">LCP</div>
                                    </div>
                                ` : ''}
                                ${ext.wptMetrics.metrics.loadTime ? `
                                    <div class="text-center">
                                        <div class="font-medium text-sm">${ext.wptMetrics.metrics.loadTime}ms</div>
                                        <div class="text-xs text-gray-400">Load</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${ext.wpt.userUrl ? `<a class="text-profound-blue text-xs hover:underline" target="_blank" href="${ext.wpt.userUrl}">🔗 View WPT Results</a>` : ''}
                        ${ext.wpt.message ? `<div class="text-xs text-gray-400 mt-1">${ext.wpt.message}</div>` : ''}
                    </div>
                `;
            } else if (ext.wpt && ext.wpt.error) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <div class="font-semibold mb-1 text-warning">WebPageTest</div>
                        <div class="text-sm text-gray-300">Error: ${ext.wpt.error}</div>
                        <div class="text-xs text-gray-400 mt-1">💡 Requires WPT_API_KEY environment variable</div>
                    </div>
                `;
            }
            
            // If no external services are configured or working
            if (!lighthouseData && !ext.psi && !ext.wpt) {
                html += `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-info-circle text-4xl mb-4 opacity-50"></i>
                        <h3 class="text-lg font-semibold mb-2">External Audits Not Configured</h3>
                        <p class="text-sm mb-4">Enable Lighthouse, PageSpeed Insights, or WebPageTest for comprehensive performance analysis.</p>
                        <div class="text-xs bg-gray-800/50 rounded p-3 max-w-md mx-auto">
                            <strong>Setup Options:</strong><br>
                            • Enable "Run Lighthouse (slower)" checkbox<br>
                            • Set PSI_API_KEY environment variable<br>
                            • Set WPT_API_KEY environment variable
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function renderAIAdvancedResults(aiAdvanced) {
            let html = '<div class="space-y-6">';
            
            // AI Readiness Score Header
            const score = aiAdvanced.overallScore || 0;
            const grade = aiAdvanced.grade || 'F';
            const scoreColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
            
            html += `
                <div class="test-result bg-gradient-to-r from-purple-900/30 to-indigo-900/30 rounded-lg p-6 border border-purple-500/20">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-purple-300 flex items-center gap-2">
                            <i class="fas fa-brain"></i>
                            AI Content Analysis
                        </h3>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${scoreColor}">${score}</div>
                            <div class="text-lg font-semibold ${scoreColor}">Grade ${grade}</div>
                        </div>
                    </div>
            `;
            
            // Sub-Metrics Grid
            if (aiAdvanced.subMetrics) {
                html += `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-purple-400">${Math.round(aiAdvanced.subMetrics.answerClarity?.score || 0)}</div>
                            <div class="text-xs text-gray-400">Answer Clarity</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-purple-400">${Math.round(aiAdvanced.subMetrics.structuredData?.score || 0)}</div>
                            <div class="text-xs text-gray-400">Structured Data</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-purple-400">${Math.round(aiAdvanced.subMetrics.extractableFacts?.score || 0)}</div>
                            <div class="text-xs text-gray-400">Extractable Facts</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-purple-400">${Math.round(aiAdvanced.subMetrics.citations?.score || 0)}</div>
                            <div class="text-xs text-gray-400">Citations</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-purple-400">${Math.round(aiAdvanced.subMetrics.recency?.score || 0)}</div>
                            <div class="text-xs text-gray-400">Content Recency</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-purple-400">${Math.round(aiAdvanced.subMetrics.technicalOptimization?.score || 0)}</div>
                            <div class="text-xs text-gray-400">Technical</div>
                        </div>
                    </div>
                `;
            }
            
            // Content Analysis Details
            if (aiAdvanced.subMetrics?.answerClarity?.details) {
                const clarity = aiAdvanced.subMetrics.answerClarity.details;
                html += `
                    <div class="mb-6">
                        <h4 class="font-semibold text-purple-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-lightbulb"></i> Content Structure Analysis
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;
                
                // Heading Analysis
                if (clarity.headingStructure) {
                    const headings = clarity.headingStructure;
                    html += `
                        <div class="bg-gray-800/50 rounded p-4">
                            <div class="text-sm font-medium text-purple-300 mb-2">Heading Structure</div>
                            <div class="text-2xl font-bold ${headings.score >= 70 ? 'text-green-400' : headings.score >= 40 ? 'text-yellow-400' : 'text-red-400'} mb-2">${headings.score}</div>
                            ${headings.strengths?.length > 0 ? `
                                <div class="mb-2">
                                    <div class="text-xs text-green-400 mb-1">✓ Strengths:</div>
                                    <ul class="text-xs text-gray-300 space-y-1">
                                        ${headings.strengths.map(s => `<li>• ${s}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${headings.issues?.length > 0 ? `
                                <div>
                                    <div class="text-xs text-red-400 mb-1">⚠ Issues:</div>
                                    <ul class="text-xs text-gray-300 space-y-1">
                                        ${headings.issues.map(i => `<li>• ${i}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Q&A Patterns
                if (clarity.qaPatterns) {
                    const qa = clarity.qaPatterns;
                    html += `
                        <div class="bg-gray-800/50 rounded p-4">
                            <div class="text-sm font-medium text-purple-300 mb-2">Q&A Optimization</div>
                            <div class="text-2xl font-bold ${qa.score >= 70 ? 'text-green-400' : qa.score >= 40 ? 'text-yellow-400' : 'text-red-400'} mb-2">${qa.score}</div>
                            <div class="text-xs text-gray-400 space-y-1">
                                <div>Explicit Q&A: ${qa.details?.explicitQA || 0}</div>
                                <div>Implicit Q&A: ${qa.details?.implicitQA || 0}</div>
                                <div>FAQ Structure: ${qa.details?.faqStructure ? 'Yes' : 'No'}</div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            // Readability Analysis
            if (aiAdvanced.subMetrics?.readabilityScore) {
                const readability = aiAdvanced.subMetrics.readabilityScore;
                html += `
                    <div class="mb-6">
                        <h4 class="font-semibold text-blue-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-book-open"></i> Readability Analysis
                        </h4>
                        <div class="bg-gray-800/50 rounded p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                                <div class="text-center">
                                    <div class="text-xl font-bold text-blue-400">${Math.round(readability.score)}</div>
                                    <div class="text-xs text-gray-400">Readability Score</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xl font-bold text-blue-400">${readability.avgSentenceLength?.toFixed(1) || 0}</div>
                                    <div class="text-xs text-gray-400">Avg Sentence Length</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xl font-bold text-blue-400">${readability.avgSyllablesPerWord?.toFixed(1) || 0}</div>
                                    <div class="text-xs text-gray-400">Syllables per Word</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xl font-bold text-blue-400">${readability.technicalLevel || 'N/A'}</div>
                                    <div class="text-xs text-gray-400">Technical Level</div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-400">
                                <strong>Grade Level:</strong> ${readability.grade || 'Unknown'}
                            </div>
                            ${readability.suggestions?.length > 0 ? `
                                <div class="mt-3">
                                    <div class="text-xs text-yellow-400 mb-1">💡 Suggestions:</div>
                                    <ul class="text-xs text-gray-300 space-y-1">
                                        ${readability.suggestions.map(s => `<li>• ${s}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Language Analysis
            if (aiAdvanced.language) {
                const lang = aiAdvanced.language;
                html += `
                    <div class="mb-6">
                        <h4 class="font-semibold text-green-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-language"></i> Language Analysis
                        </h4>
                        <div class="bg-gray-800/50 rounded p-4">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-xl font-bold text-green-400">${lang.language?.toUpperCase() || 'Unknown'}</div>
                                    <div class="text-xs text-gray-400">Detected Language</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xl font-bold text-green-400">${Math.round((lang.confidence || 0) * 100)}%</div>
                                    <div class="text-xs text-gray-400">Confidence</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xl font-bold text-green-400">${lang.detectedMethods || 0}</div>
                                    <div class="text-xs text-gray-400">Detection Methods</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Recommendations
            if (aiAdvanced.recommendations && aiAdvanced.recommendations.length > 0) {
                // Group recommendations by type
                const recByType = {};
                aiAdvanced.recommendations.forEach(rec => {
                    if (!recByType[rec.type]) recByType[rec.type] = [];
                    recByType[rec.type].push(rec);
                });
                
                html += `
                    <div class="mb-6">
                        <h4 class="font-semibold text-yellow-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-tasks"></i> AI Optimization Recommendations
                        </h4>
                        <div class="space-y-3">
                `;
                
                Object.entries(recByType).forEach(([type, recs]) => {
                    const typeColors = {
                        'structuredData': 'border-blue-500 bg-blue-900/20',
                        'answerClarity': 'border-purple-500 bg-purple-900/20',
                        'citations': 'border-green-500 bg-green-900/20',
                        'recency': 'border-orange-500 bg-orange-900/20',
                        'technical': 'border-red-500 bg-red-900/20',
                        'extractableFacts': 'border-cyan-500 bg-cyan-900/20'
                    };
                    const colorClass = typeColors[type] || 'border-gray-500 bg-gray-900/20';
                    
                    recs.forEach(rec => {
                        const priorityColor = rec.priority === 'high' ? 'text-red-400' : rec.priority === 'medium' ? 'text-yellow-400' : 'text-green-400';
                        html += `
                            <div class="${colorClass} border rounded p-3">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="font-medium text-white capitalize">${type.replace(/([A-Z])/g, ' $1')}</div>
                                    <span class="text-xs px-2 py-1 rounded ${priorityColor} bg-opacity-20">${rec.priority?.toUpperCase() || 'MEDIUM'}</span>
                                </div>
                                <div class="text-sm text-gray-300 mb-2">${rec.message}</div>
                                ${rec.specifics?.length > 0 ? `
                                    <ul class="text-xs text-gray-400 space-y-1">
                                        ${rec.specifics.map(s => `<li>• ${s}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${typeof rec.score === 'number' ? `
                                    <div class="text-xs text-gray-500 mt-2">Current Score: ${Math.round(rec.score)}/100</div>
                                ` : ''}
                            </div>
                        `;
                    });
                });
                
                html += '</div></div>';
            }
            
            // Action Buttons
            html += `
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showDetailedAIMetrics()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-medium">
                            <i class="fas fa-chart-bar mr-1"></i>Detailed Metrics
                        </button>
                        <button onclick="exportAIAnalysis()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm font-medium">
                            <i class="fas fa-download mr-1"></i>Export Analysis
                        </button>
                        <button onclick="generateAIActionPlan()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium">
                            <i class="fas fa-list-check mr-1"></i>AI Action Plan
                        </button>
                    </div>
                </div>
            `;
            
            html += '</div>';
            return html;
        }

        function renderAIResults(ai) {
            let html = '<div class="space-y-4">';
            
            // Add witty AI microcopy section first
            const aiWittyIssues = [];
            
            // AI Surfaces scoring commentary
            const surfaces = window.currentResults?.tests?.aiSurfaces || ai.aiSurfacesReadiness;
            if (surfaces) {
                if (surfaces.overallScore >= 80) {
                    aiWittyIssues.push('• AI Surfaces Score: Robots love your content more than humans do.');
                } else if (surfaces.overallScore >= 60) {
                    aiWittyIssues.push('• AI Surfaces Score: ChatGPT thinks you\'re okay. Room for improvement.');
                } else {
                    aiWittyIssues.push('• AI Surfaces Score: Even AI is confused by your content.');
                }
            }
            
            // Robots.txt commentary
            if (ai.robots) {
                const allowedBots = Object.values(ai.robots.allows || {}).filter(allowed => allowed).length;
                const totalBots = Object.keys(ai.robots.allows || {}).length;
                
                if (allowedBots === totalBots && totalBots > 0) {
                    aiWittyIssues.push('• robots.txt: Welcome mat for all AI crawlers. Very hospitable.');
                } else if (allowedBots === 0) {
                    aiWittyIssues.push('• robots.txt: Fort Knox level security. No robots allowed.');
                } else {
                    aiWittyIssues.push(`• robots.txt: Playing favorites - ${allowedBots}/${totalBots} bots allowed.`);
                }
            }
            
            // General AI commentary
            aiWittyIssues.push('• AI Training: Your content might teach the next ChatGPT to be sarcastic.');
            
            // Display witty AI feedback
            if (aiWittyIssues.length > 0) {
                html += `
                    <div class="test-result bg-indigo-900/20 rounded-lg p-4 border border-indigo-500/30">
                        <h3 class="font-semibold mb-3 text-indigo-400">AI Attention Reality Check</h3>
                        <ul class="space-y-1 text-sm text-gray-300">
                            ${aiWittyIssues.join('<br>')}
                        </ul>
                        <div class="mt-3 text-xs text-gray-400">
                            💡 Pro tip: AI bots are just very sophisticated readers. If humans can't understand your content, neither can they.
                        </div>
                    </div>
                `;
            }
            
            // AI Surfaces Readiness Score (Flagship Feature)
            // Route the correct data from tests.aiSurfaces to this better layout
            if (surfaces) {
                html += `
                <div class="test-result bg-gradient-to-r from-indigo-900/30 to-purple-900/30 rounded-lg p-6 border border-indigo-500/20">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-indigo-300 flex items-center gap-2">
                            <i class="fas fa-robot"></i>
                            AI Surfaces Readiness
                            <button onclick="showAIScoringInfo()" class="text-indigo-400 hover:text-indigo-300 text-sm ml-1">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </h3>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${surfaces.overallScore >= 80 ? 'text-green-400' : surfaces.overallScore >= 60 ? 'text-yellow-400' : 'text-red-400'}">${surfaces.overallScore}</div>
                            <div class="text-lg font-semibold ${surfaces.grade === 'A+' || surfaces.grade === 'A' ? 'text-green-400' : surfaces.grade === 'B' || surfaces.grade === 'C' ? 'text-yellow-400' : 'text-red-400'}">${surfaces.grade}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-indigo-400">${surfaces.subMetrics.answerClarity.score}</div>
                            <div class="text-xs text-gray-400">Answer Clarity</div>
                            <div class="text-xs text-gray-500">25% weight</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-indigo-400">${surfaces.subMetrics.structuredData.score}</div>
                            <div class="text-xs text-gray-400">Structured Data</div>
                            <div class="text-xs text-gray-500">20% weight</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-indigo-400">${surfaces.subMetrics.extractableFacts.score}</div>
                            <div class="text-xs text-gray-400">Extractable Facts</div>
                            <div class="text-xs text-gray-500">20% weight</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-indigo-400">${surfaces.subMetrics.citations.score}</div>
                            <div class="text-xs text-gray-400">Citations</div>
                            <div class="text-xs text-gray-500">15% weight</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-indigo-400">${surfaces.subMetrics.recency.score}</div>
                            <div class="text-xs text-gray-400">Content Recency</div>
                            <div class="text-xs text-gray-500">10% weight</div>
                        </div>
                        <div class="text-center p-3 bg-gray-800/50 rounded">
                            <div class="text-xl font-bold text-indigo-400">${surfaces.subMetrics.technicalOptimization.score}</div>
                            <div class="text-xs text-gray-400">Technical</div>
                            <div class="text-xs text-gray-500">10% weight</div>
                        </div>
                    </div>

                    ${surfaces.strengths.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-green-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> Strengths
                            </h4>
                            <ul class="text-sm text-green-300 space-y-1">
                                ${surfaces.strengths.map(s => `<li>• ${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${surfaces.recommendations.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-yellow-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-lightbulb"></i> Top Recommendations
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${surfaces.recommendations.map(r => `<li>• ${r}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showDetailedAIAnalysis()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm font-medium">
                            <i class="fas fa-chart-line mr-1"></i>Detailed Analysis
                        </button>
                        <button onclick="exportAIReport()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-medium">
                            <i class="fas fa-download mr-1"></i>Export AI Report
                        </button>
                    </div>
                </div>`;
            }
            

            // Enhanced AI Overview Optimization
            if (ai.aiOverviewOptimization) {
                const aio = ai.aiOverviewOptimization;
                html += `
                <div class="test-result bg-blue-900/20 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-400 mb-3 flex items-center gap-2">
                        <i class="fas fa-search"></i>
                        Google AI Overview Optimization
                        <span class="text-sm font-normal text-blue-300">${aio.score}%</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400">${aio.featuredSnippetPotential}%</div>
                            <div class="text-xs text-gray-400">Featured Snippet Potential</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400">${aio.structureOptimization}%</div>
                            <div class="text-xs text-gray-400">Structure Optimization</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400">${aio.entityRecognition}%</div>
                            <div class="text-xs text-gray-400">Entity Recognition</div>
                        </div>
                    </div>
                    ${aio.recommendations.length > 0 ? `
                        <div class="text-sm">
                            <strong class="text-blue-300">Recommendations:</strong>
                            <ul class="mt-1 space-y-1 text-gray-300">
                                ${aio.recommendations.slice(0, 3).map(r => `<li>• ${r}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>`;
            }

            // Traditional AI Readiness (robots.txt, etc.)
            if (ai.robots) {
                const allows = ai.robots.allows || {};
                html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold">Crawler Access (robots.txt)</span>
                        <a href="${ai.robots.url}" target="_blank" class="text-violet-400 text-xs">Open</a>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                        ${Object.keys(allows).map(bot => `
                            <div class="${allows[bot] ? 'text-green-400' : 'text-yellow-400'}">${bot}: ${allows[bot] ? 'Allowed' : 'Blocked'}</div>
                        `).join('')}
                    </div>
                </div>`;
            }

            // llms.txt and external tools
            html += `
                <div class="test-result bg-gray-800/30 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-3 font-semibold">AI Crawler Tools</div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="generateLlmsTxt()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm">Generate llms.txt</button>
                        <a href="https://seomator.com/google-ai-overview-keywords-checker" target="_blank" class="px-4 py-2 bg-blue-800 hover:bg-blue-700 rounded text-blue-300 text-sm">AI Overview Keywords</a>
                        <a href="https://seomator.com/google-ai-mode-checker" target="_blank" class="px-4 py-2 bg-green-800 hover:bg-green-700 rounded text-green-300 text-sm">AI Mode Checker</a>
                    </div>
                    <pre id="llmsPreview" class="mt-3 text-xs text-gray-400 hidden"></pre>
                </div>
            `;

            html += '</div>';
            return html;
        }

        function renderMultiBotResults(multiBot) {
            let html = '<div class="space-y-4">';
            
            // Simplified to just the "Big 5" bots with witty labels
            const bigFiveBots = {
                'GoogleBot': { 
                    name: 'GoogleBot', 
                    wittyLabel: 'The Search Overlord',
                    description: 'Decides if you exist or not',
                    icon: '🔍',
                    color: 'text-blue-400 bg-blue-900/20'
                },
                'ChatGPT-User': { 
                    name: 'OpenAI', 
                    wittyLabel: 'The Know-It-All',
                    description: 'Training on your content since 2021',
                    icon: '🤖',
                    color: 'text-green-400 bg-green-900/20'
                },
                'Claude-Web': { 
                    name: 'Claude', 
                    wittyLabel: 'The Polite One',
                    description: 'Actually says please and thank you',
                    icon: '🎭',
                    color: 'text-purple-400 bg-purple-900/20'
                },
                'BingBot': { 
                    name: 'Bing', 
                    wittyLabel: 'The Underdog',
                    description: 'Tries really hard to be relevant',
                    icon: '🔎',
                    color: 'text-orange-400 bg-orange-900/20'
                },
                'PerplexityBot': { 
                    name: 'Perplexity', 
                    wittyLabel: 'The Summarizer',
                    description: 'Turns your content into citations',
                    icon: '📚',
                    color: 'text-cyan-400 bg-cyan-900/20'
                }
            };
            
            html += `
                <div class="test-result bg-gradient-to-r from-cyan-900/20 to-purple-900/20 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-cyan-300 mb-4 flex items-center gap-2">
                        <i class="fas fa-users"></i>
                        The Big 5: Who's Accessing Your Content
                    </h3>
                    <div class="text-sm text-gray-400 mb-6">
                        These are the bots that actually matter. Everyone else is just noise.
                    </div>
            `;
            
            // Create grid of the Big 5
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            
            Object.values(bigFiveBots).forEach(bot => {
                // Check if this bot is actually in the data
                const botData = multiBot.bots?.find(b => 
                    b.name.toLowerCase().includes(bot.name.toLowerCase()) ||
                    b.userAgent.toLowerCase().includes(bot.name.toLowerCase())
                );
                
                const status = botData ? (botData.allowed ? 'Allowed' : 'Blocked') : 'Unknown';
                const statusColor = botData ? (botData.allowed ? 'text-green-400' : 'text-red-400') : 'text-gray-500';
                
                html += `
                    <div class="${bot.color} rounded-lg p-4 border border-opacity-30">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="text-2xl">${bot.icon}</div>
                            <div>
                                <div class="font-semibold">${bot.name}</div>
                                <div class="text-xs opacity-75">${bot.wittyLabel}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-300 mb-2">${bot.description}</div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-medium ${statusColor}">${status}</span>
                            ${botData ? `<div class="text-xs text-gray-400">Last seen: Recently</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add witty summary
            const allowedCount = Object.values(bigFiveBots).filter(bot => {
                const botData = multiBot.bots?.find(b => 
                    b.name.toLowerCase().includes(bot.name.toLowerCase()) ||
                    b.userAgent.toLowerCase().includes(bot.name.toLowerCase())
                );
                return botData?.allowed;
            }).length;
            
            html += `
                <div class="mt-4 p-4 bg-gray-800/30 rounded-lg">
                    <div class="text-sm text-gray-300">
                        <strong>Reality Check:</strong> ${allowedCount}/5 of the important bots can access your content. 
                        ${allowedCount === 5 ? 'You\'re the popular kid at the robot lunch table! 🎉' : 
                          allowedCount >= 3 ? 'Decent bot street cred. Could be better. 📈' : 
                          allowedCount >= 1 ? 'Some bots like you. Others... not so much. 🤷‍♂️' : 
                          'Congratulations, you\'ve achieved digital invisibility! 👻'}
                    </div>
                </div>
            `;
            
            html += '</div>';
            
            // Bot Type Breakdown
            if (multiBot.summary?.byType) {
                html += `
                    <div class="mb-4">
                        <h4 class="font-semibold text-cyan-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-chart-pie"></i> Bot Types Distribution
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                `;
                
                Object.entries(multiBot.summary.byType).forEach(([type, count]) => {
                    const typeColors = {
                        'search': 'text-blue-400 bg-blue-900/20',
                        'ai-training': 'text-purple-400 bg-purple-900/20',
                        'ai-browse': 'text-green-400 bg-green-900/20',
                        'ai-search': 'text-orange-400 bg-orange-900/20'
                    };
                    const colorClass = typeColors[type] || 'text-gray-400 bg-gray-900/20';
                    
                    html += `
                        <div class="${colorClass} rounded p-3 text-center">
                            <div class="text-xl font-bold">${count}</div>
                            <div class="text-xs capitalize">${type.replace('-', ' ')}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // Impact Analysis
            if (multiBot.impact) {
                const impact = multiBot.impact;
                html += `
                    <div class="mb-4">
                        <h4 class="font-semibold text-purple-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-chart-line"></i> Impact Analysis
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                `;
                
                if (impact.seo) {
                    html += `
                        <div class="bg-gray-800/50 rounded p-4">
                            <div class="text-center mb-2">
                                <div class="text-2xl font-bold text-blue-400">${impact.seo.score}</div>
                                <div class="text-sm text-gray-400">SEO Score</div>
                            </div>
                            <ul class="text-xs text-gray-300 space-y-1">
                                ${impact.seo.factors.map(factor => `<li>• ${factor}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (impact.dataControl) {
                    html += `
                        <div class="bg-gray-800/50 rounded p-4">
                            <div class="text-center mb-2">
                                <div class="text-2xl font-bold text-yellow-400">${impact.dataControl.score}</div>
                                <div class="text-sm text-gray-400">Data Control</div>
                            </div>
                            <ul class="text-xs text-gray-300 space-y-1">
                                ${impact.dataControl.factors.map(factor => `<li>• ${factor}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (impact.aiIntegration) {
                    html += `
                        <div class="bg-gray-800/50 rounded p-4">
                            <div class="text-center mb-2">
                                <div class="text-2xl font-bold text-green-400">${impact.aiIntegration.score}</div>
                                <div class="text-sm text-gray-400">AI Integration</div>
                            </div>
                            <ul class="text-xs text-gray-300 space-y-1">
                                ${impact.aiIntegration.factors.map(factor => `<li>• ${factor}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            // Bot Details Matrix
            if (multiBot.botMatrix && Object.keys(multiBot.botMatrix).length > 0) {
                // Convert botMatrix object to array for easier processing
                const botArray = Object.entries(multiBot.botMatrix).map(([name, data]) => ({
                    bot: name,
                    ...data,
                    allowed: data.access?.effective?.allowed !== false
                }));
                
                html += `
                    <div class="mb-4">
                        <h4 class="font-semibold text-cyan-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-table"></i> Detailed Bot Analysis (${botArray.length} Crawlers)
                        </h4>
                        <div class="space-y-2">
                `;
                
                botArray.forEach(bot => {
                    const allowed = bot.allowed;
                    const statusColor = allowed ? 'text-green-400' : 'text-red-400';
                    const statusIcon = allowed ? 'fa-check-circle' : 'fa-times-circle';
                    const bgColor = allowed ? 'bg-green-900/10' : 'bg-red-900/10';
                    const borderColor = bot.critical ? 'border-yellow-400' : 'border-gray-700';
                    
                    html += `
                        <div class="${bgColor} rounded p-3 border ${borderColor}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-white">${bot.bot}</span>
                                    ${bot.critical ? '<span class="text-xs bg-yellow-600 text-black px-1 rounded">CRITICAL</span>' : ''}
                                    <i class="fas ${statusIcon} ${statusColor}"></i>
                                </div>
                                <div class="text-sm ${statusColor} font-medium">
                                    ${allowed ? 'Allowed' : 'Blocked'}
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 mb-1">
                                <span class="capitalize">${bot.type.replace('-', ' ')}</span> • ${bot.company}
                            </div>
                            <div class="text-xs text-gray-300 mb-2">${bot.description}</div>
                            <div class="text-xs text-gray-500">
                                ${allowed ? bot.recommendations?.allow || 'Bot is allowed to access' : bot.recommendations?.block || 'Bot is blocked from access'}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // Warnings
            if (multiBot.stealthWarnings && multiBot.stealthWarnings.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="font-semibold text-yellow-400 mb-3 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i> Warnings & Alerts
                        </h4>
                        <div class="space-y-2">
                `;
                
                multiBot.stealthWarnings.forEach(warning => {
                    const severityColor = warning.severity === 'high' ? 'text-red-400 bg-red-900/20' : 
                                         warning.severity === 'medium' ? 'text-yellow-400 bg-yellow-900/20' : 
                                         'text-blue-400 bg-blue-900/20';
                    
                    html += `
                        <div class="${severityColor} rounded p-3 border border-current border-opacity-30">
                            <div class="font-medium mb-1">${warning.title}</div>
                            <div class="text-sm mb-2">${warning.message}</div>
                            <div class="text-xs opacity-75">
                                <strong>Recommendation:</strong> ${warning.recommendation}
                            </div>
                            ${warning.action ? `<div class="text-xs opacity-75 mt-1"><strong>Action:</strong> ${warning.action}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // Action Buttons
            html += `
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showDetailedBotAnalysis()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-sm font-medium">
                            <i class="fas fa-microscope mr-1"></i>Detailed Analysis
                        </button>
                        <button onclick="exportBotReport()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium">
                            <i class="fas fa-download mr-1"></i>Export Report
                        </button>
                        <button onclick="generateOptimalRobotsTxt()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-medium">
                            <i class="fas fa-cogs mr-1"></i>Generate robots.txt
                        </button>
                    </div>
                </div>
            `;
            
            html += '</div>';
            return html;
        }

        function renderAISurfaces(s) {
            const color = s.score >= 80 ? 'status-good' : s.score >= 60 ? 'status-warning' : 'status-error';
            const weights = s.weights || {};
            const subs = s.subs || {};
            let html = `
                <div class="test-result bg-gray-800/30 rounded-lg p-4 mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-semibold">AI Surfaces Readiness</div>
                        <div class="text-lg font-bold ${color}">${s.score}/100 (${s.grade})</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                        ${Object.entries(subs).map(([k,v]) => {
                            const w = weights[k] || 0;
                            return `<div class=\"bg-gray-900/40 rounded p-3\"><div class=\"text-gray-400\">${k} (${w}%)</div><div class=\"font-semibold\">${Math.round(v)}</div></div>`;
                        }).join('')}
                    </div>
                    ${s.recommendations && s.recommendations.length ? `
                        <div class=\"mt-3\">
                            <div class=\"text-gray-400 text-sm mb-1\">Recommendations</div>
                            <ul class=\"text-xs text-gray-300 list-disc ml-5\">
                                ${s.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    <div class="mt-3 flex gap-2">
                        <button onclick="exportAISurfacesCsv()" class="px-3 py-2 bg-gray-800 rounded hover:bg-gray-700 text-xs"><i class="fas fa-file-csv mr-1"></i>Export AI Score (CSV)</button>
                    </div>
                </div>
            `;
            return html;
        }

        function renderAEOResults(aeo) {
            let html = '<div class="space-y-4">';
            
            // Comparison Content Analysis
            if (aeo.comparisonContent) {
                const comp = aeo.comparisonContent;
                const score = comp.score;
                const grade = score >= 90 ? 'A+' : score >= 80 ? 'A' : score >= 70 ? 'B' : score >= 60 ? 'C' : score >= 50 ? 'D' : 'F';
                const color = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
                
                html += `
                <div class="test-result bg-gradient-to-r from-orange-900/30 to-red-900/30 rounded-lg p-6 border border-orange-500/20">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-orange-300 flex items-center gap-2">
                            <i class="fas fa-balance-scale"></i>
                            Comparison Content Analysis
                        </h3>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${color}">${score}</div>
                            <div class="text-lg font-semibold ${color}">Grade ${grade}</div>
                        </div>
                    </div>
                    
                    ${Object.keys(comp.findings).length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                            ${comp.findings.comparisonTables ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-orange-400">${comp.findings.comparisonTables}</div>
                                    <div class="text-xs text-gray-400">Comparison Tables</div>
                                </div>
                            ` : ''}
                            ${comp.findings.vsContent ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-orange-400">${comp.findings.vsContent}</div>
                                    <div class="text-xs text-gray-400">VS/Versus Content</div>
                                </div>
                            ` : ''}
                            ${comp.findings.prosConsLists ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-orange-400">${comp.findings.prosConsLists}</div>
                                    <div class="text-xs text-gray-400">Pros/Cons Lists</div>
                                </div>
                            ` : ''}
                            ${comp.findings.featureComparisons ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-orange-400">${comp.findings.featureComparisons.lists || 0}</div>
                                    <div class="text-xs text-gray-400">Feature Lists</div>
                                </div>
                            ` : ''}
                            ${comp.findings.decisionContent ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-orange-400">${comp.findings.decisionContent}</div>
                                    <div class="text-xs text-gray-400">Decision Guidance</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${comp.details.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-orange-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> Analysis Details
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${comp.details.map(detail => `<li>• ${detail}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${comp.recommendations.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-yellow-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-lightbulb"></i> AEO Recommendations
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${comp.recommendations.map(rec => `<li>• ${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showDetailedAEOAnalysis()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded text-sm font-medium">
                            <i class="fas fa-chart-line mr-1"></i>Detailed AEO Analysis
                        </button>
                        <button onclick="exportAEOReport()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-sm font-medium">
                            <i class="fas fa-download mr-1"></i>Export AEO Report
                        </button>
                    </div>
                </div>`;
            }

            // Expert Authority Analysis
            if (aeo.expertAuthority) {
                const auth = aeo.expertAuthority;
                const score = auth.score;
                const grade = score >= 90 ? 'A+' : score >= 80 ? 'A' : score >= 70 ? 'B' : score >= 60 ? 'C' : score >= 50 ? 'D' : 'F';
                const color = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
                
                html += `
                <div class="test-result bg-gradient-to-r from-blue-900/30 to-indigo-900/30 rounded-lg p-6 border border-blue-500/20 mt-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-blue-300 flex items-center gap-2">
                            <i class="fas fa-user-graduate"></i>
                            Expert Authority Analysis
                        </h3>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${color}">${score}</div>
                            <div class="text-lg font-semibold ${color}">Grade ${grade}</div>
                        </div>
                    </div>
                    
                    ${Object.keys(auth.findings).length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                            ${auth.findings.authorBios ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-blue-400">${auth.findings.authorBios}</div>
                                    <div class="text-xs text-gray-400">Author Bios</div>
                                </div>
                            ` : ''}
                            ${auth.findings.credentials ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-blue-400">${auth.findings.credentials}</div>
                                    <div class="text-xs text-gray-400">Credentials</div>
                                </div>
                            ` : ''}
                            ${auth.findings.experienceIndicators ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-blue-400">${auth.findings.experienceIndicators}</div>
                                    <div class="text-xs text-gray-400">Experience Indicators</div>
                                </div>
                            ` : ''}
                            ${auth.findings.authoritySignals ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-blue-400">${auth.findings.authoritySignals}</div>
                                    <div class="text-xs text-gray-400">Authority Signals</div>
                                </div>
                            ` : ''}
                            ${auth.findings.contactInfo ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-blue-400">${auth.findings.contactInfo}</div>
                                    <div class="text-xs text-gray-400">Contact Info</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${auth.details.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-blue-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> E-E-A-T Analysis Details
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${auth.details.map(detail => `<li>• ${detail}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${auth.recommendations.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-yellow-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-lightbulb"></i> Authority Recommendations
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${auth.recommendations.map(rec => `<li>• ${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showDetailedAuthorityAnalysis()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium">
                            <i class="fas fa-user-tie mr-1"></i>Authority Details
                        </button>
                        <button onclick="exportAuthorityReport()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm font-medium">
                            <i class="fas fa-certificate mr-1"></i>Export E-E-A-T Report
                        </button>
                    </div>
                </div>`;
            }

            // Content Chunking Analysis
            if (aeo.contentChunking) {
                const chunk = aeo.contentChunking;
                const score = chunk.score;
                const grade = score >= 90 ? 'A+' : score >= 80 ? 'A' : score >= 70 ? 'B' : score >= 60 ? 'C' : score >= 50 ? 'D' : 'F';
                const color = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
                
                html += `
                <div class="test-result bg-gradient-to-r from-purple-900/30 to-pink-900/30 rounded-lg p-6 border border-purple-500/20 mt-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-purple-300 flex items-center gap-2">
                            <i class="fas fa-th-list"></i>
                            Content Chunking Analysis
                        </h3>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${color}">${score}</div>
                            <div class="text-lg font-semibold ${color}">Grade ${grade}</div>
                        </div>
                    </div>
                    
                    ${Object.keys(chunk.findings).length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                            ${chunk.findings.paragraphAnalysis ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-purple-400">${chunk.findings.paragraphAnalysis.optimalRatio}%</div>
                                    <div class="text-xs text-gray-400">Optimal Paragraphs</div>
                                    <div class="text-xs text-gray-500">${chunk.findings.paragraphAnalysis.optimal}/${chunk.findings.paragraphAnalysis.total}</div>
                                </div>
                            ` : ''}
                            ${chunk.findings.headingHierarchy ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-purple-400">${chunk.findings.headingHierarchy.totalHeadings}</div>
                                    <div class="text-xs text-gray-400">Total Headings</div>
                                    <div class="text-xs text-gray-500">${chunk.findings.headingHierarchy.hierarchyBreaks} breaks</div>
                                </div>
                            ` : ''}
                            ${chunk.findings.contentChunking ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-purple-400">${chunk.findings.contentChunking.lists}</div>
                                    <div class="text-xs text-gray-400">Lists</div>
                                    <div class="text-xs text-gray-500">${chunk.findings.contentChunking.listItems} items</div>
                                </div>
                            ` : ''}
                            ${chunk.findings.contentChunking?.visualBreaks ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-purple-400">${chunk.findings.contentChunking.visualBreaks}</div>
                                    <div class="text-xs text-gray-400">Visual Breaks</div>
                                </div>
                            ` : ''}
                            ${chunk.findings.readabilityMetrics ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-purple-400">${chunk.findings.readabilityMetrics.avgSentenceLength}</div>
                                    <div class="text-xs text-gray-400">Avg Sentence Length</div>
                                    <div class="text-xs text-gray-500">words</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${chunk.details.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-purple-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> Chunking Analysis Details
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${chunk.details.map(detail => `<li>• ${detail}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${chunk.recommendations.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-yellow-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-lightbulb"></i> Chunking Recommendations
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${chunk.recommendations.map(rec => `<li>• ${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showDetailedChunkingAnalysis()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-sm font-medium">
                            <i class="fas fa-chart-bar mr-1"></i>Chunking Details
                        </button>
                        <button onclick="exportChunkingReport()" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 rounded text-sm font-medium">
                            <i class="fas fa-file-alt mr-1"></i>Export Structure Report
                        </button>
                    </div>
                </div>`;
            }

            // Citation Quality Assessment
            if (aeo.citationQuality) {
                const cite = aeo.citationQuality;
                const score = cite.score;
                const grade = score >= 90 ? 'A+' : score >= 80 ? 'A' : score >= 70 ? 'B' : score >= 60 ? 'C' : score >= 50 ? 'D' : 'F';
                const color = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
                
                html += `
                <div class="test-result bg-gradient-to-r from-cyan-900/30 to-teal-900/30 rounded-lg p-6 border border-cyan-500/20 mt-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-cyan-300 flex items-center gap-2">
                            <i class="fas fa-link"></i>
                            Citation Quality Assessment
                        </h3>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${color}">${score}</div>
                            <div class="text-lg font-semibold ${color}">Grade ${grade}</div>
                        </div>
                    </div>
                    
                    ${Object.keys(cite.findings).length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            ${cite.findings.externalLinks ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-cyan-400">${cite.findings.externalLinks}</div>
                                    <div class="text-xs text-gray-400">External Links</div>
                                </div>
                            ` : ''}
                            ${cite.findings.authorityDomains ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-cyan-400">${cite.findings.authorityDomains}</div>
                                    <div class="text-xs text-gray-400">Authority Domains</div>
                                </div>
                            ` : ''}
                            ${cite.findings.citationContexts ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-cyan-400">${cite.findings.citationContexts}</div>
                                    <div class="text-xs text-gray-400">Citation Contexts</div>
                                </div>
                            ` : ''}
                            ${cite.findings.diverseDomains ? `
                                <div class="text-center p-3 bg-gray-800/50 rounded">
                                    <div class="text-xl font-bold text-cyan-400">${cite.findings.diverseDomains}</div>
                                    <div class="text-xs text-gray-400">Diverse Sources</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${cite.findings.authorityBreakdown ? `
                            <div class="bg-gray-800/30 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-cyan-400 mb-3">Authority Sources Breakdown</h4>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                                    ${cite.findings.authorityBreakdown.government ? `
                                        <div class="text-center p-2 bg-green-900/30 rounded">
                                            <div class="font-bold text-green-400">${cite.findings.authorityBreakdown.government}</div>
                                            <div class="text-green-300">Government</div>
                                        </div>
                                    ` : ''}
                                    ${cite.findings.authorityBreakdown.academic ? `
                                        <div class="text-center p-2 bg-blue-900/30 rounded">
                                            <div class="font-bold text-blue-400">${cite.findings.authorityBreakdown.academic}</div>
                                            <div class="text-blue-300">Academic</div>
                                        </div>
                                    ` : ''}
                                    ${cite.findings.authorityBreakdown.news ? `
                                        <div class="text-center p-2 bg-purple-900/30 rounded">
                                            <div class="font-bold text-purple-400">${cite.findings.authorityBreakdown.news}</div>
                                            <div class="text-purple-300">News Media</div>
                                        </div>
                                    ` : ''}
                                    ${cite.findings.authorityBreakdown.professional ? `
                                        <div class="text-center p-2 bg-orange-900/30 rounded">
                                            <div class="font-bold text-orange-400">${cite.findings.authorityBreakdown.professional}</div>
                                            <div class="text-orange-300">Professional</div>
                                        </div>
                                    ` : ''}
                                    ${cite.findings.authorityBreakdown.statistics ? `
                                        <div class="text-center p-2 bg-yellow-900/30 rounded">
                                            <div class="font-bold text-yellow-400">${cite.findings.authorityBreakdown.statistics}</div>
                                            <div class="text-yellow-300">Statistics</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}

                    ${cite.details.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-cyan-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> Citation Analysis Details
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${cite.details.map(detail => `<li>• ${detail}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${cite.recommendations.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-yellow-400 mb-2 flex items-center gap-1">
                                <i class="fas fa-lightbulb"></i> Citation Improvement Recommendations
                            </h4>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${cite.recommendations.map(rec => `<li>• ${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showDetailedCitationAnalysis()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-sm font-medium">
                            <i class="fas fa-search-plus mr-1"></i>Citation Details
                        </button>
                        <button onclick="exportCitationReport()" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 rounded text-sm font-medium">
                            <i class="fas fa-download mr-1"></i>Export Citation Report
                        </button>
                    </div>
                </div>`;
            }
            
            html += '</div>';
            return html;
        }

        function exportAISurfacesCsv() {
            if (!currentResults?.tests?.aiSurfaces) return alert('No AI Surfaces data');
            const s = currentResults.tests.aiSurfaces;
            const headers = ['url','score','grade','answerClarity','structuredData','extractableFacts','citations','recency','technical'];
            const subs = s.subs || {};
            const row = [currentResults.url, s.score, s.grade, Math.round(subs.answerClarity||0), Math.round(subs.structuredData||0), Math.round(subs.extractableFacts||0), Math.round(subs.citations||0), Math.round(subs.recency||0), Math.round(subs.technical||0)];
            const csv = [headers.join(','), row.join(',')].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ai-surfaces-${(currentResults.url||'').replace(/[^a-z0-9]/gi,'_')}-${Date.now()}.csv`;
            a.click();
        }

        async function generateLlmsTxt() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            if (!url || !isValidUrl(url)) {
                alert('Please enter a valid URL');
                return;
            }
            try {
                const r = await fetch(`${BACKEND_URL}/api/llms/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                if (!r.ok) throw new Error('Generation failed');
                const txt = await r.text();
                const pre = document.getElementById('llmsPreview');
                pre.textContent = txt;
                pre.classList.remove('hidden');
                // Offer download
                const blob = new Blob([txt], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'llms.txt';
                a.textContent = 'Download llms.txt';
                a.className = 'inline-block mt-2 text-violet-300 hover:text-violet-200';
                pre.insertAdjacentElement('afterend', a);
            } catch (e) {
                alert('Failed to generate llms.txt');
            }
        }
        
        // AI Analysis Action Functions
        function showDetailedAIMetrics() {
            alert('Detailed AI metrics view - Coming soon!');
        }
        
        function exportAIAnalysis() {
            if (!currentResults?.tests?.aiAdvanced) {
                alert('No AI analysis data available');
                return;
            }
            
            const data = currentResults.tests.aiAdvanced;
            const csv = [
                ['Metric', 'Score', 'Grade'],
                ['Overall AI Readiness', data.overallScore, data.grade],
                ['Answer Clarity', Math.round(data.subMetrics?.answerClarity?.score || 0), ''],
                ['Structured Data', Math.round(data.subMetrics?.structuredData?.score || 0), ''],
                ['Extractable Facts', Math.round(data.subMetrics?.extractableFacts?.score || 0), ''],
                ['Citations', Math.round(data.subMetrics?.citations?.score || 0), ''],
                ['Content Recency', Math.round(data.subMetrics?.recency?.score || 0), ''],
                ['Technical Optimization', Math.round(data.subMetrics?.technicalOptimization?.score || 0), ''],
                ['Readability Score', Math.round(data.subMetrics?.readabilityScore?.score || 0), data.subMetrics?.readabilityScore?.grade || '']
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ai-analysis-${Date.now()}.csv`;
            a.click();
        }
        
        function generateAIActionPlan() {
            if (!currentResults?.tests?.aiAdvanced?.recommendations) {
                alert('No AI recommendations available');
                return;
            }
            
            const recs = currentResults.tests.aiAdvanced.recommendations;
            const highPriority = recs.filter(r => r.priority === 'high');
            const mediumPriority = recs.filter(r => r.priority === 'medium');
            const lowPriority = recs.filter(r => r.priority === 'low');
            
            let plan = '# AI Optimization Action Plan\n\n';
            
            if (highPriority.length > 0) {
                plan += '## High Priority (Do First)\n';
                highPriority.forEach((rec, i) => {
                    plan += `${i + 1}. **${rec.type}**: ${rec.message}\n`;
                    if (rec.specifics?.length > 0) {
                        rec.specifics.forEach(s => plan += `   - ${s}\n`);
                    }
                    plan += '\n';
                });
            }
            
            if (mediumPriority.length > 0) {
                plan += '## Medium Priority\n';
                mediumPriority.forEach((rec, i) => {
                    plan += `${i + 1}. **${rec.type}**: ${rec.message}\n`;
                });
                plan += '\n';
            }
            
            if (lowPriority.length > 0) {
                plan += '## Low Priority (Nice to Have)\n';
                lowPriority.forEach((rec, i) => {
                    plan += `${i + 1}. **${rec.type}**: ${rec.message}\n`;
                });
            }
            
            const blob = new Blob([plan], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `ai-action-plan-${Date.now()}.md`;
            a.click();
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        async function clearCache() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/cache/clear`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Cache cleared successfully');
                    checkServerStatus();
                }
            } catch (error) {
                alert('Failed to clear cache. Is the server running?');
            }
        }

        // Sitemap audit functionality
        let sitemapResults = [];
        async function startSitemapAudit() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            console.log('Starting sitemap audit for:', url);
            
            if (!url || !isValidUrl(url)) {
                alert('Please enter a valid URL');
                return;
            }

            // Disable button and show progress
            const btn = document.getElementById('sitemapBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader inline-block mr-2"></div>Scanning...';
            
            const progressSection = document.getElementById('progressSection');
            progressSection.classList.remove('hidden');
            document.getElementById('progressText').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting sitemap analysis...';
            
            try {
                // Get max URLs from input, default to 50
                const maxUrlsInput = document.getElementById('maxUrlsInput');
                const maxUrls = maxUrlsInput.value ? parseInt(maxUrlsInput.value) : 50;
                
                console.log('Fetching from:', `${BACKEND_URL}/api/sitemap-audit`);
                const response = await fetch(`${BACKEND_URL}/api/sitemap-audit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, maxUrls })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                sitemapResults = data;
                displaySitemapResults(data);
                
            } catch (error) {
                console.error('Sitemap audit error:', error);
                alert(`Sitemap audit failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sitemap"></i><span>Sitemap Scan</span>';
                progressSection.classList.add('hidden');
            }
        }

        function displaySitemapResults(data) {
            console.log('displaySitemapResults called with:', data);
            
            // Make sure resultsSection is visible first
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
                resultsSection.classList.remove('hidden');
            }
            
            const sitemapSection = document.getElementById('sitemapResultsSection');
            if (!sitemapSection) {
                console.error('sitemapResultsSection element not found!');
                return;
            }
            sitemapSection.classList.remove('hidden');
            
            const container = document.getElementById('sitemapResults');
            if (!container) {
                console.error('sitemapResults element not found!');
                return;
            }
            
            console.log('Displaying results...');
            let html = '';
            
            // Summary stats
            html += `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="metric-card rounded-lg p-4">
                        <div class="text-gray-400 text-xs uppercase mb-1">URLs Analyzed</div>
                        <div class="text-2xl font-bold">${data.totalUrls || 0}</div>
                        ${data.totalUrlsInSitemap && data.totalUrlsInSitemap > data.totalUrls ? 
                            `<div class="text-xs text-gray-500">of ${data.totalUrlsInSitemap} total</div>` : ''
                        }
                    </div>
                    <div class="metric-card rounded-lg p-4">
                        <div class="text-gray-400 text-xs uppercase mb-1">Schema Issues</div>
                        <div class="text-2xl font-bold text-yellow-400">${data.schemaIssues || 0}</div>
                    </div>
                    <div class="metric-card rounded-lg p-4">
                        <div class="text-gray-400 text-xs uppercase mb-1">Missing Schemas</div>
                        <div class="text-2xl font-bold text-red-400">${data.missingSchemas || 0}</div>
                    </div>
                    <div class="metric-card rounded-lg p-4">
                        <div class="text-gray-400 text-xs uppercase mb-1">Avg Score</div>
                        <div class="text-2xl font-bold">${data.avgScore || 0}%</div>
                    </div>
                </div>
            `;

            // Results by content type
            if (data.byContentType) {
                html += `
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold mb-3">Results by Content Type</h3>
                `;
                
                for (const [type, pages] of Object.entries(data.byContentType)) {
                    html += `
                        <div class="test-result bg-gray-800/30 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold capitalize">${type}</h4>
                                <span class="text-sm text-gray-400">${pages.length} pages</span>
                            </div>
                            <div class="space-y-2">
                    `;
                    
                    pages.slice(0, 5).forEach(page => {
                        html += `
                            <div class="flex items-center justify-between text-sm">
                                <span class="truncate flex-1 mr-4">${page.url}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs px-2 py-1 rounded ${page.hasRecommendedSchema ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">
                                        ${page.hasRecommendedSchema ? 'Schema OK' : 'Schema Missing'}
                                    </span>
                                    ${page.recommendedSchema ? `<span class="text-xs text-gray-400">${page.recommendedSchema}</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    if (pages.length > 5) {
                        html += `<div class="text-xs text-gray-400">...and ${pages.length - 5} more</div>`;
                    }
                    
                    html += '</div></div>';
                }
                
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function exportSitemapCsv() {
            if (!sitemapResults || !sitemapResults.pages) {
                alert('No sitemap results to export');
                return;
            }
            
            const headers = ['url', 'contentType', 'title', 'hasSchema', 'recommendedSchema', 'currentSchema', 'issues'];
            const rows = [headers.join(',')];
            
            sitemapResults.pages.forEach(page => {
                const row = [
                    page.url,
                    page.contentType || '',
                    `"${(page.title || '').replace(/"/g, '""')}"`,
                    page.hasRecommendedSchema ? 'yes' : 'no',
                    page.recommendedSchema || '',
                    page.currentSchema || '',
                    `"${(page.issues || []).join('; ').replace(/"/g, '""')}"`
                ];
                rows.push(row.join(','));
            });
            
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `sitemap-audit-${Date.now()}.csv`;
            a.click();
        }

        function showSchemaRecommendations() {
            if (!sitemapResults) {
                alert('No sitemap results available');
                return;
            }
            
            const el = document.getElementById('schemaRecommendations');
            el.classList.remove('hidden');
            
            let html = '<div class="space-y-4">';
            html += '<h3 class="text-lg font-semibold mb-4">Schema Recommendations</h3>';
            
            // Group by recommended schema
            const bySchema = {};
            sitemapResults.pages?.forEach(page => {
                if (page.recommendedSchema && !page.hasRecommendedSchema) {
                    if (!bySchema[page.recommendedSchema]) {
                        bySchema[page.recommendedSchema] = [];
                    }
                    bySchema[page.recommendedSchema].push(page);
                }
            });
            
            for (const [schema, pages] of Object.entries(bySchema)) {
                html += `
                    <div class="test-result bg-gray-800/30 rounded-lg p-4">
                        <h4 class="font-semibold mb-2">${schema} Schema</h4>
                        <p class="text-sm text-gray-400 mb-3">${pages.length} pages missing this schema</p>
                        <div class="space-y-1">
                `;
                
                pages.slice(0, 10).forEach(page => {
                    html += `<div class="text-sm text-gray-300">• ${page.url}</div>`;
                });
                
                if (pages.length > 10) {
                    html += `<div class="text-xs text-gray-400">...and ${pages.length - 10} more</div>`;
                }
                
                html += '</div></div>';
            }
            
            html += '</div>';
            el.innerHTML = html;
        }

        // Fix Priorities System
        function showFixPriorities() {
            if (!currentResults && !sitemapResults) {
                alert('Run an audit first to see fix priorities');
                return;
            }
            
            const data = currentResults || sitemapResults;
            const priorities = calculateFixPriorities(data);
            displayFixPriorities(priorities);
        }

        function calculateFixPriorities(data) {
            const priorities = {
                critical: [],
                high: [],
                medium: [],
                low: []
            };

            // For single page analysis
            if (data.tests) {
                // Critical issues
                if (!data.tests.metadata?.title) {
                    priorities.critical.push({
                        issue: 'Missing page title',
                        impact: 'Search engines cannot understand page topic',
                        effort: 'Low',
                        timeEstimate: '5 min'
                    });
                }
                
                if (!data.tests.metadata?.description) {
                    priorities.critical.push({
                        issue: 'Missing meta description',
                        impact: 'Poor search result snippets, lower CTR',
                        effort: 'Low',
                        timeEstimate: '10 min'
                    });
                }

                if (!data.tests.schema?.found) {
                    priorities.critical.push({
                        issue: 'No structured data found',
                        impact: 'Invisible to AI systems and rich snippets',
                        effort: 'Medium',
                        timeEstimate: '30 min'
                    });
                }

                // High priority issues
                if (data.tests.accessibility?.issues?.length > 0) {
                    const a11yData = data.tests.accessibility;
                    let detailedDescription = `${a11yData.issues.length} accessibility violations:\n`;
                    
                    // Add specific details from accessibility data
                    if (a11yData.images?.withoutAlt > 0) {
                        detailedDescription += `• ${a11yData.images.withoutAlt} images without alt text\n`;
                    }
                    if (a11yData.links?.empty > 0) {
                        detailedDescription += `• ${a11yData.links.empty} empty links\n`;
                    }
                    if (a11yData.forms?.inputsWithoutLabels > 0) {
                        detailedDescription += `• ${a11yData.forms.inputsWithoutLabels} form fields without labels\n`;
                    }
                    if (a11yData.headings?.h1Count === 0) {
                        detailedDescription += `• Missing H1 heading\n`;
                    }
                    if (a11yData.headings?.h1Count > 1) {
                        detailedDescription += `• Multiple H1 headings (${a11yData.headings.h1Count})\n`;
                    }
                    if (a11yData.headings?.structureIssues) {
                        detailedDescription += `• Heading hierarchy problems\n`;
                    }
                    if (!a11yData.lang) {
                        detailedDescription += `• Missing language attribute\n`;
                    }
                    
                    // Add axe-core violations if available
                    if (a11yData.axe?.violations?.length > 0) {
                        detailedDescription += `• ${a11yData.axe.violations.length} automated violations found\n`;
                    }

                    priorities.high.push({
                        issue: detailedDescription.trim(),
                        impact: 'Legal compliance risk, poor user experience, SEO penalties',
                        effort: 'Medium',
                        timeEstimate: `${Math.ceil(a11yData.issues.length * 0.5)} hours`
                    });
                }

                if (!data.tests.files?.sitemap?.exists) {
                    priorities.high.push({
                        issue: 'Missing XML sitemap',
                        impact: 'Search engines may miss important pages',
                        effort: 'Medium',
                        timeEstimate: '20 min'
                    });
                }

                if (data.tests.performance?.score?.loadTime === 'poor') {
                    let perfDetails = 'Slow page loading performance:\n';
                    const perfMetrics = data.tests.performance.metrics;
                    
                    if (perfMetrics?.loadComplete > 5000) {
                        perfDetails += `• Total load time: ${Math.round(perfMetrics.loadComplete/1000)}s (target: <3s)\n`;
                    }
                    if (perfMetrics?.firstContentfulPaint > 2500) {
                        perfDetails += `• First Contentful Paint: ${Math.round(perfMetrics.firstContentfulPaint)}ms (target: <1.8s)\n`;
                    }
                    if (perfMetrics?.domContentLoaded > 3000) {
                        perfDetails += `• DOM Content Loaded: ${Math.round(perfMetrics.domContentLoaded/1000)}s\n`;
                    }
                    if (perfMetrics?.resources > 100) {
                        perfDetails += `• Too many resources: ${perfMetrics.resources} (optimize: images, CSS, JS)\n`;
                    }
                    
                    priorities.high.push({
                        issue: perfDetails.trim(),
                        impact: 'High bounce rate, poor Core Web Vitals, reduced search rankings',
                        effort: 'High',
                        timeEstimate: '4-8 hours'
                    });
                }

                // Medium priority issues
                if (data.tests.metadata?.issues?.length > 0) {
                    let metaDetails = `Meta tag optimization needed:\n`;
                    data.tests.metadata.issues.forEach(issue => {
                        metaDetails += `• ${issue}\n`;
                    });
                    
                    priorities.medium.push({
                        issue: metaDetails.trim(),
                        impact: 'Suboptimal search appearance, reduced click-through rates',
                        effort: 'Low',
                        timeEstimate: '15 min'
                    });
                }

                if (!data.tests.files?.llms?.exists) {
                    priorities.medium.push({
                        issue: 'Missing llms.txt for AI crawlers',
                        impact: 'Reduced AI system visibility and citation potential',
                        effort: 'Low',
                        timeEstimate: '10 min'
                    });
                }

                // AI Overview optimization issues
                if (data.tests.ai?.aiOverviewOptimization) {
                    const aio = data.tests.ai.aiOverviewOptimization;
                    if (aio.score < 50) {
                        let aiIssues = 'Poor Google AI Overview optimization:\n';
                        if (aio.featuredSnippetPotential < 30) aiIssues += '• Low featured snippet potential\n';
                        if (aio.structureOptimization < 30) aiIssues += '• Poor content structure for AI\n';
                        if (aio.entityRecognition < 30) aiIssues += '• Insufficient entity recognition\n';
                        
                        priorities.high.push({
                            issue: aiIssues.trim(),
                            impact: 'Reduced visibility in Google AI Overviews and voice search',
                            effort: 'Medium',
                            timeEstimate: '2-3 hours'
                        });
                    }
                }

                // LLM optimization issues
                if (data.tests.ai?.llmOptimization) {
                    const llm = data.tests.ai.llmOptimization;
                    if (llm.score < 50) {
                        let llmIssues = 'Poor LLM crawler optimization:\n';
                        if (llm.citationFriendly < 30) llmIssues += '• Content not citation-friendly\n';
                        if (llm.semanticStructure < 30) llmIssues += '• Poor semantic structure\n';
                        if (llm.factualContent < 30) llmIssues += '• Insufficient factual content\n';
                        
                        priorities.medium.push({
                            issue: llmIssues.trim(),
                            impact: 'Reduced AI chatbot citations and knowledge graph inclusion',
                            effort: 'Medium',
                            timeEstimate: '3-4 hours'
                        });
                    }
                }

                // AI Surfaces Readiness Score integration
                if (data.tests.aiSurfaces && data.tests.aiSurfaces.subMetrics) {
                    const aiSurfaces = data.tests.aiSurfaces;
                    
                    // Critical AI readiness issues (score < 30)
                    if (aiSurfaces.overallScore < 30) {
                        let criticalAIIssues = `Critical AI Surfaces readiness issues (Score: ${aiSurfaces.overallScore}/100):\n`;
                        
                        if (aiSurfaces.subMetrics && typeof aiSurfaces.subMetrics === 'object') {
                            Object.entries(aiSurfaces.subMetrics).forEach(([key, metric]) => {
                                if (metric && typeof metric === 'object' && metric.score < 30) {
                                    const metricName = key.replace(/([A-Z])/g, ' $1').toLowerCase();
                                    criticalAIIssues += `• Poor ${metricName}: ${metric.score}/100\n`;
                                    if (metric.recommendations && Array.isArray(metric.recommendations) && metric.recommendations.length > 0) {
                                        criticalAIIssues += `  - ${metric.recommendations[0]}\n`;
                                    }
                                }
                            });
                        }
                        
                        priorities.critical.push({
                            issue: criticalAIIssues.trim(),
                            impact: 'Severely limited AI visibility, no Google AI Overview potential',
                            effort: 'High',
                            timeEstimate: '6-8 hours'
                        });
                    }
                    // High priority AI readiness issues (score 30-50)
                    else if (aiSurfaces.overallScore < 50) {
                        let highAIIssues = `AI Surfaces readiness needs improvement (Score: ${aiSurfaces.overallScore}/100):\n`;
                        
                        if (aiSurfaces.subMetrics && typeof aiSurfaces.subMetrics === 'object') {
                            Object.entries(aiSurfaces.subMetrics).forEach(([key, metric]) => {
                                if (metric && typeof metric === 'object' && metric.score < 50) {
                                    const metricName = key.replace(/([A-Z])/g, ' $1').toLowerCase();
                                    highAIIssues += `• ${metricName}: ${metric.score}/100\n`;
                                }
                            });
                        }
                        
                        if (highAIIssues.length > 100) { // Only add if we found actual issues
                            priorities.high.push({
                                issue: highAIIssues.trim(),
                                impact: 'Limited AI visibility, reduced Google AI Overview potential',
                                effort: 'Medium',
                                timeEstimate: '4-6 hours'
                            });
                        }
                    }
                    // Medium priority AI readiness issues (score 50-70)
                    else if (aiSurfaces.overallScore < 70) {
                        let mediumAIIssues = `AI Surfaces optimization opportunities (Score: ${aiSurfaces.overallScore}/100):\n`;
                        
                        if (aiSurfaces.subMetrics && typeof aiSurfaces.subMetrics === 'object') {
                            const weakestMetrics = Object.entries(aiSurfaces.subMetrics)
                                .filter(([_, metric]) => metric && typeof metric === 'object' && metric.score < 70)
                                .sort((a, b) => a[1].score - b[1].score)
                                .slice(0, 3);
                            
                            weakestMetrics.forEach(([key, metric]) => {
                                const metricName = key.replace(/([A-Z])/g, ' $1').toLowerCase();
                                mediumAIIssues += `• Improve ${metricName}: ${metric.score}/100\n`;
                            });
                        }
                        
                        if (mediumAIIssues.length > 100) { // Only add if we found actual issues
                            priorities.medium.push({
                                issue: mediumAIIssues.trim(),
                                impact: 'Good AI visibility but room for optimization',
                                effort: 'Medium',
                                timeEstimate: '2-4 hours'
                            });
                        }
                    }
                    
                    // Add specific recommendations from lowest scoring metrics
                    if (aiSurfaces.subMetrics && typeof aiSurfaces.subMetrics === 'object') {
                        const lowestMetric = Object.entries(aiSurfaces.subMetrics)
                            .filter(([_, metric]) => metric && typeof metric === 'object')
                            .sort((a, b) => a[1].score - b[1].score)[0];
                        
                        if (lowestMetric && lowestMetric[1] && Array.isArray(lowestMetric[1].recommendations) && lowestMetric[1].recommendations.length > 0) {
                            const [metricKey, metric] = lowestMetric;
                            const metricName = metricKey.replace(/([A-Z])/g, ' $1').toLowerCase();
                            
                            metric.recommendations.slice(0, 2).forEach((rec, index) => {
                                priorities.medium.push({
                                    issue: `AI ${metricName} enhancement: ${rec}`,
                                    impact: 'Improved AI system understanding and citation potential',
                                    effort: 'Low',
                                    timeEstimate: '30-60 min'
                                });
                            });
                        }
                    }
                }

                // Low priority issues
                if (!data.tests.metadata?.og?.image) {
                    priorities.low.push({
                        issue: 'Missing Open Graph image',
                        impact: 'Poor social media sharing appearance',
                        effort: 'Low',
                        timeEstimate: '5 min'
                    });
                }
            }

            // For sitemap analysis
            if (data.pages) {
                const totalPages = data.pages.length;
                const pagesWithIssues = data.pages.filter(p => p.issues.length > 0).length;
                const missingSchemas = data.missingSchemas || 0;

                if (missingSchemas > totalPages * 0.5) {
                    let schemaDetails = `${missingSchemas} pages missing proper schema markup:\n`;
                    
                    // Group by content type for better understanding
                    const schemaByType = {};
                    data.pages.filter(p => !p.hasRecommendedSchema).forEach(page => {
                        const type = page.recommendedSchema || 'Unknown';
                        if (!schemaByType[type]) schemaByType[type] = 0;
                        schemaByType[type]++;
                    });
                    
                    if (schemaByType && typeof schemaByType === 'object') {
                        Object.entries(schemaByType).forEach(([type, count]) => {
                            schemaDetails += `• ${count} ${type.toLowerCase()} pages need ${type} schema\n`;
                        });
                    }

                    priorities.critical.push({
                        issue: schemaDetails.trim(),
                        impact: 'Poor AI system understanding, limited rich snippets, reduced Google AI Overview visibility',
                        effort: 'High',
                        timeEstimate: `${Math.ceil(missingSchemas * 0.5)} hours`
                    });
                }

                if (pagesWithIssues > totalPages * 0.3) {
                    let issueDetails = `${pagesWithIssues} pages have technical issues:\n`;
                    
                    // Count common issues across pages
                    const issueCount = {};
                    data.pages.forEach(page => {
                        page.issues.forEach(issue => {
                            if (!issueCount[issue]) issueCount[issue] = 0;
                            issueCount[issue]++;
                        });
                    });
                    
                    // Show top 5 most common issues
                    if (issueCount && typeof issueCount === 'object') {
                        Object.entries(issueCount)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5)
                            .forEach(([issue, count]) => {
                                issueDetails += `• ${count} pages: ${issue}\n`;
                            });
                    }

                    priorities.high.push({
                        issue: issueDetails.trim(),
                        impact: 'Inconsistent search performance, poor user experience across site',
                        effort: 'High',
                        timeEstimate: `${Math.ceil(pagesWithIssues * 0.25)} hours`
                    });
                }
            }

            // Add AEO (Answer Engine Optimization) issues
            if (data.tests?.aeo) {
                const aeo = data.tests.aeo;
                
                // Comparison Content Analysis
                if (aeo.comparisonContent && aeo.comparisonContent.score < 70) {
                    let compDetails = 'Comparison content optimization needed:\n';
                    const comp = aeo.comparisonContent;
                    
                    if (!comp.findings.comparisonTables || comp.findings.comparisonTables === 0) {
                        compDetails += '• No comparison tables found\n';
                    }
                    if (!comp.findings.vsContent || comp.findings.vsContent === 0) {
                        compDetails += '• Missing "vs" or comparison content\n';
                    }
                    if (!comp.findings.prosConsLists || comp.findings.prosConsLists === 0) {
                        compDetails += '• No pros/cons analysis found\n';
                    }
                    
                    const priority = comp.score < 40 ? 'high' : comp.score < 60 ? 'medium' : 'low';
                    priorities[priority].push({
                        issue: compDetails.trim(),
                        impact: 'Poor visibility in AI-powered search comparisons and decision queries',
                        effort: 'Medium',
                        timeEstimate: '2-4 hours'
                    });
                }
                
                // Expert Authority Analysis
                if (aeo.expertAuthority && aeo.expertAuthority.score < 70) {
                    let authDetails = 'Expert authority signals missing:\n';
                    const auth = aeo.expertAuthority;
                    
                    if (!auth.findings.authorBios || auth.findings.authorBios === 0) {
                        authDetails += '• No author bio sections found\n';
                    }
                    if (!auth.findings.credentials || auth.findings.credentials === 0) {
                        authDetails += '• Missing professional credentials\n';
                    }
                    if (!auth.findings.contactInfo || auth.findings.contactInfo === 0) {
                        authDetails += '• Lack of contact/transparency information\n';
                    }
                    
                    const priority = auth.score < 40 ? 'high' : auth.score < 60 ? 'medium' : 'low';
                    priorities[priority].push({
                        issue: authDetails.trim(),
                        impact: 'Poor E-E-A-T signals, reduced trust from AI systems and users',
                        effort: 'Medium-High',
                        timeEstimate: '3-6 hours'
                    });
                }
                
                // Content Chunking Analysis
                if (aeo.contentChunking && aeo.contentChunking.score < 70) {
                    let chunkDetails = 'Content structure optimization needed:\n';
                    const chunk = aeo.contentChunking;
                    
                    if (chunk.findings.longParagraphs && chunk.findings.longParagraphs > 0) {
                        chunkDetails += `• ${chunk.findings.longParagraphs} paragraphs are too long for AI parsing\n`;
                    }
                    if (chunk.findings.headingIssues) {
                        chunkDetails += '• Heading hierarchy problems detected\n';
                    }
                    if (!chunk.findings.lists || chunk.findings.lists === 0) {
                        chunkDetails += '• Insufficient use of lists for scannability\n';
                    }
                    
                    const priority = chunk.score < 40 ? 'medium' : 'low';
                    priorities[priority].push({
                        issue: chunkDetails.trim(),
                        impact: 'Reduced AI content extraction and poor readability for both users and bots',
                        effort: 'Medium',
                        timeEstimate: '2-3 hours'
                    });
                }
                
                // Citation Quality Assessment
                if (aeo.citationQuality && aeo.citationQuality.score < 70) {
                    let citeDetails = 'Citation quality improvements needed:\n';
                    const cite = aeo.citationQuality;
                    
                    if (!cite.findings.authorityDomains || cite.findings.authorityDomains === 0) {
                        citeDetails += '• No high-authority sources cited\n';
                    }
                    if (!cite.findings.citationContexts || cite.findings.citationContexts === 0) {
                        citeDetails += '• Citations lack proper context\n';
                    }
                    if (!cite.findings.diverseDomains || cite.findings.diverseDomains < 3) {
                        citeDetails += '• Insufficient source diversity\n';
                    }
                    
                    const priority = cite.score < 40 ? 'high' : cite.score < 60 ? 'medium' : 'low';
                    priorities[priority].push({
                        issue: citeDetails.trim(),
                        impact: 'Poor credibility signals for AI fact-checking and source verification',
                        effort: 'Medium',
                        timeEstimate: '2-4 hours'
                    });
                }
            }

            return priorities;
        }

        function displayFixPriorities(priorities) {
            const section = document.getElementById('fixPrioritiesSection');
            const container = document.getElementById('fixPriorities');
            
            section.classList.remove('hidden');
            
            let html = '';
            
            const priorityLevels = [
                { level: 'critical', title: 'Critical (Fix Immediately)', color: 'red', icon: 'fas fa-fire' },
                { level: 'high', title: 'High Priority (This Week)', color: 'orange', icon: 'fas fa-exclamation-circle' },
                { level: 'medium', title: 'Medium Priority (This Month)', color: 'yellow', icon: 'fas fa-clock' },
                { level: 'low', title: 'Low Priority (Nice to Have)', color: 'blue', icon: 'fas fa-info-circle' }
            ];

            priorityLevels.forEach(({ level, title, color, icon }) => {
                const items = priorities[level];
                if (items.length === 0) return;

                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-${color}-400">
                            <i class="${icon}"></i>
                            ${title} (${items.length})
                        </h3>
                        <div class="space-y-3">
                `;

                items.forEach((item, index) => {
                    // Format multiline descriptions properly
                    const formattedIssue = item.issue.replace(/\n/g, '<br>');
                    
                    html += `
                        <div class="bg-gray-800/30 rounded-lg p-4 border-l-4 border-${color}-500">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white mb-2 leading-relaxed">${formattedIssue}</h4>
                                    <p class="text-gray-400 text-sm mb-3 leading-relaxed">${item.impact}</p>
                                    <div class="flex items-center gap-4 text-xs">
                                        <span class="bg-gray-700 px-2 py-1 rounded">
                                            Effort: ${item.effort}
                                        </span>
                                        <span class="bg-gray-700 px-2 py-1 rounded">
                                            Time: ${item.timeEstimate}
                                        </span>
                                    </div>
                                </div>
                                <input type="checkbox" class="mt-1 accent-${color}-500" title="Mark as completed">
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            });

            if (Object.values(priorities).every(arr => arr.length === 0)) {
                html = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-green-400 text-4xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-green-400 mb-2">Excellent Work!</h3>
                        <p class="text-gray-400">No critical issues found. Your site is in great shape!</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function exportPrioritiesCsv() {
            if (!currentResults && !sitemapResults) {
                alert('No audit data available');
                return;
            }

            const data = currentResults || sitemapResults;
            const priorities = calculateFixPriorities(data);
            
            const headers = ['Priority', 'Issue', 'Impact', 'Effort', 'Time Estimate', 'Status'];
            const rows = [headers.join(',')];

            ['critical', 'high', 'medium', 'low'].forEach(level => {
                priorities[level].forEach(item => {
                    const row = [
                        level.toUpperCase(),
                        `"${item.issue.replace(/"/g, '""')}"`,
                        `"${item.impact.replace(/"/g, '""')}"`,
                        item.effort,
                        item.timeEstimate,
                        'Pending'
                    ];
                    rows.push(row.join(','));
                });
            });

            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `fix-priorities-${Date.now()}.csv`;
            a.click();
        }

        function generateActionPlan() {
            if (!currentResults && !sitemapResults) {
                alert('No audit data available');
                return;
            }

            const data = currentResults || sitemapResults;
            const priorities = calculateFixPriorities(data);
            
            let plan = '# SEO Fix Action Plan\n\n';
            plan += `Generated: ${new Date().toLocaleDateString()}\n`;
            plan += `Site: ${data.url || 'Multiple pages'}\n\n`;

            ['critical', 'high', 'medium', 'low'].forEach(level => {
                const items = priorities[level];
                if (items.length === 0) return;

                plan += `## ${level.toUpperCase()} PRIORITY (${items.length} items)\n\n`;
                
                items.forEach((item, index) => {
                    plan += `### ${index + 1}. ${item.issue}\n`;
                    plan += `**Impact:** ${item.impact}\n`;
                    plan += `**Effort:** ${item.effort} | **Time:** ${item.timeEstimate}\n`;
                    plan += `**Status:** [ ] Pending\n\n`;
                });
            });

            const blob = new Blob([plan], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `action-plan-${Date.now()}.md`;
            a.click();
        }
        
        function exportFullReport() {
            if (!currentResults) {
                alert('No results to export');
                return;
            }
            
            const blob = new Blob([JSON.stringify(currentResults, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `seo-audit-${currentResults.url.replace(/[^a-z0-9]/gi, '_')}-${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportCsvReport() {
            if (!currentResults) {
                alert('No results to export');
                return;
            }
            const r = currentResults;
            const headers = [
                'url','perfGrade','a11yIssues','seoScore','fcp_ms','load_ms','resources','cdn','cache','server',
                'psi_score','wpt_ttfb_ms','wpt_fcp_ms','wpt_lcp_ms','lh_perf','lh_a11y','lh_seo','ai_score',
                'robots','sitemap','rss','llms','schema_types','schema_required_issues'
            ];
            const perfGrade = (r.tests.performance?.score?.loadTime === 'good' && r.tests.performance?.score?.fcp === 'good') ? 'A' : ((r.tests.performance?.score?.loadTime !== 'poor' && r.tests.performance?.score?.fcp !== 'poor') ? 'B' : 'C');
            let seoScore = 100;
            if (r.tests.metadata?.issues) seoScore -= r.tests.metadata.issues.length * 5;
            if (!r.tests.files?.robots?.exists) seoScore -= 10;
            if (!r.tests.files?.sitemap?.exists) seoScore -= 10;
            const a11yIssues = (r.tests.accessibility?.issues?.length || 0);
            const row = [
                r.url,
                perfGrade,
                a11yIssues,
                Math.max(0, seoScore),
                r.tests.performance?.metrics?.firstContentfulPaint || '',
                r.tests.performance?.metrics?.loadComplete || '',
                r.tests.performance?.metrics?.resources || '',
                r.tests.headers?.cdn || '',
                r.tests.headers?.cacheStatus || '',
                r.tests.headers?.server || '',
                r.tests.external?.psi?.score ?? '',
                r.tests.external?.wptMetrics?.ttfb ?? '',
                r.tests.external?.wptMetrics?.fcp ?? '',
                r.tests.external?.wptMetrics?.lcp ?? '',
                r.tests.lighthouse?.scores?.performance ?? '',
                r.tests.lighthouse?.scores?.accessibility ?? '',
                r.tests.lighthouse?.scores?.seo ?? '',
                r.tests.ai?.score ?? '',
                r.tests.files?.robots?.exists ? 'yes' : 'no',
                r.tests.files?.sitemap?.exists ? 'yes' : 'no',
                r.tests.files?.rss?.exists ? 'yes' : 'no',
                r.tests.files?.llms?.exists ? 'yes' : 'no',
                (r.tests.schema?.types || []).join('|'),
                (r.tests.schema?.requiredIssues || []).length || 0
            ];
            const csv = [headers.join(','), row.map(v => (typeof v === 'string' && /[",\n]/.test(v)) ? '"' + v.replace(/"/g,'""') + '"' : v).join(',')].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `seo-audit-${(r.url || '').replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.csv`;
            a.click();
        }
        
        function resetTool() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('urlInput').value = '';
            currentResults = null;
        }
        
        function showAIScoringInfo() {
            const modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.remove()">
                    <div class="bg-gray-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-700">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-white">AI Surfaces Readiness Score Calculation</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <p class="text-gray-300">The AI Surfaces Readiness Score evaluates how well your content performs with AI systems like Google AI Overviews, ChatGPT, and other LLM crawlers.</p>
                            
                            <div class="space-y-3">
                                <h4 class="font-semibold text-white">Weighted Sub-Metrics:</h4>
                                
                                <div class="bg-gray-800/50 p-3 rounded">
                                    <div class="font-medium text-indigo-400">Answer Clarity (25%)</div>
                                    <div class="text-sm text-gray-400">Clear headings, structured Q&A format, direct answers, readability</div>
                                </div>
                                
                                <div class="bg-gray-800/50 p-3 rounded">
                                    <div class="font-medium text-indigo-400">Structured Data (20%)</div>
                                    <div class="text-sm text-gray-400">Schema.org markup, JSON-LD implementation, AI-friendly schemas</div>
                                </div>
                                
                                <div class="bg-gray-800/50 p-3 rounded">
                                    <div class="font-medium text-indigo-400">Extractable Facts (20%)</div>
                                    <div class="text-sm text-gray-400">Factual content, data points, statistics, concrete information</div>
                                </div>
                                
                                <div class="bg-gray-800/50 p-3 rounded">
                                    <div class="font-medium text-indigo-400">Citations & Sources (15%)</div>
                                    <div class="text-sm text-gray-400">External links, authoritative sources, credible references</div>
                                </div>
                                
                                <div class="bg-gray-800/50 p-3 rounded">
                                    <div class="font-medium text-indigo-400">Content Recency (10%)</div>
                                    <div class="text-sm text-gray-400">Last modified dates, fresh content, current information</div>
                                </div>
                                
                                <div class="bg-gray-800/50 p-3 rounded">
                                    <div class="font-medium text-indigo-400">Technical Optimization (10%)</div>
                                    <div class="text-sm text-gray-400">Page speed, mobile-friendly, robots.txt, sitemap accessibility</div>
                                </div>
                            </div>
                            
                            <div class="bg-blue-900/30 border border-blue-500/20 rounded p-3">
                                <div class="font-medium text-blue-400">Grading Scale:</div>
                                <div class="text-sm text-blue-300 mt-1">
                                    A: 90-100 | B: 80-89 | C: 70-79 | D: 60-69 | F: <60
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function showDetailedAIAnalysis() {
            // Get the data from either location
            const analysis = window.currentResults?.tests?.aiSurfaces || 
                           (currentResults?.tests?.ai?.aiSurfacesReadiness ? currentResults.tests.ai.aiSurfacesReadiness : null);
            
            if (!analysis) {
                alert('No AI Surfaces analysis available');
                return;
            }
            
            // Create modal content
            const modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.remove()">
                    <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-700">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-white">AI Surfaces Readiness Analysis</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="text-3xl font-bold text-white">${analysis.overallScore}/100</div>
                                <div class="text-lg text-gray-300">Grade: ${analysis.grade}</div>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            ${Object.entries(analysis.subMetrics).map(([key, metric]) => `
                                <div class="bg-gray-800 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold text-white capitalize">${key.replace(/([A-Z])/g, ' $1').trim()}</h4>
                                        <span class="text-lg font-bold text-white">${metric.score}/100</span>
                                    </div>
                                    
                                    ${metric.details.length > 0 ? `
                                        <div class="mb-3">
                                            <h5 class="text-sm font-medium text-gray-300 mb-2">Analysis Details:</h5>
                                            <ul class="text-sm text-gray-400 space-y-1">
                                                ${metric.details.map(detail => `<li>• ${detail}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${metric.recommendations.length > 0 ? `
                                        <div>
                                            <h5 class="text-sm font-medium text-gray-300 mb-2">Recommendations:</h5>
                                            <ul class="text-sm text-blue-400 space-y-1">
                                                ${metric.recommendations.map(rec => `<li>• ${rec}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                            
                            ${analysis.strengths.length > 0 ? `
                                <div class="bg-green-900/30 border border-green-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-green-400 mb-2">Strengths</h4>
                                    <ul class="text-sm text-green-300 space-y-1">
                                        ${analysis.strengths.map(strength => `<li>• ${strength}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="bg-blue-900/30 border border-blue-500/20 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-400 mb-2">Top Recommendations</h4>
                                <ul class="text-sm text-blue-300 space-y-1">
                                    ${analysis.recommendations.slice(0, 5).map(rec => `<li>• ${rec}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }
        
        function exportAIReport() {
            // Get the data from either location
            const analysis = window.currentResults?.tests?.aiSurfaces || 
                           (currentResults?.tests?.ai?.aiSurfacesReadiness ? currentResults.tests.ai.aiSurfacesReadiness : null);
            
            if (!analysis) {
                alert('No AI Surfaces analysis available');
                return;
            }
            const url = currentResults.url || 'unknown';
            
            // Create detailed AI report
            const report = {
                url: url,
                analysisDate: new Date().toISOString(),
                aiSurfacesReadiness: {
                    overallScore: analysis.overallScore,
                    grade: analysis.grade,
                    subMetrics: analysis.subMetrics,
                    strengths: analysis.strengths,
                    recommendations: analysis.recommendations
                },
                summary: {
                    topStrengths: analysis.strengths.slice(0, 3),
                    criticalIssues: analysis.recommendations.slice(0, 3),
                    quickWins: analysis.recommendations.filter(rec => 
                        rec.includes('meta description') || 
                        rec.includes('headings') || 
                        rec.includes('alt text')
                    ).slice(0, 3)
                }
            };
            
            // Export as JSON
            const blob = new Blob([JSON.stringify(report, null, 2)], { 
                type: 'application/json' 
            });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `ai-surfaces-report-${url.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(downloadUrl);
        }

        function showDetailedAEOAnalysis() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.comparisonContent) {
                alert('No AEO analysis available');
                return;
            }
            
            const comp = aeoData.comparisonContent;
            
            const modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.remove()">
                    <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-700">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-white">Answer Engine Optimization Analysis</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="text-3xl font-bold text-white">${comp.score}/100</div>
                                <div class="text-lg text-gray-300">Comparison Content Analysis</div>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            <div class="bg-orange-900/30 border border-orange-500/20 rounded-lg p-4">
                                <h4 class="font-semibold text-orange-400 mb-3">Findings Breakdown</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${comp.findings.comparisonTables ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Comparison Tables: ${comp.findings.comparisonTables}</div>
                                            <div class="text-sm text-gray-400">Structured comparison tables found</div>
                                        </div>
                                    ` : ''}
                                    ${comp.findings.vsContent ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">VS Content: ${comp.findings.vsContent}</div>
                                            <div class="text-sm text-gray-400">Direct comparison phrases</div>
                                        </div>
                                    ` : ''}
                                    ${comp.findings.prosConsLists ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Pros/Cons: ${comp.findings.prosConsLists}</div>
                                            <div class="text-sm text-gray-400">Advantage/disadvantage lists</div>
                                        </div>
                                    ` : ''}
                                    ${comp.findings.decisionContent ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Decision Content: ${comp.findings.decisionContent}</div>
                                            <div class="text-sm text-gray-400">Decision-making guidance</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${comp.details.length > 0 ? `
                                <div class="bg-gray-800/30 rounded-lg p-4">
                                    <h4 class="font-semibold text-white mb-3">Analysis Details</h4>
                                    <ul class="text-gray-300 space-y-2">
                                        ${comp.details.map(detail => `<li class="flex items-start gap-2"><i class="fas fa-check-circle text-green-400 mt-1"></i><span>${detail}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${comp.recommendations.length > 0 ? `
                                <div class="bg-blue-900/30 border border-blue-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-400 mb-3">AEO Recommendations</h4>
                                    <ul class="text-blue-300 space-y-2">
                                        ${comp.recommendations.map(rec => `<li class="flex items-start gap-2"><i class="fas fa-lightbulb text-yellow-400 mt-1"></i><span>${rec}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function exportAEOReport() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.comparisonContent) {
                alert('No AEO analysis available');
                return;
            }

            const url = currentResults.url || 'unknown';
            
            const report = {
                url: url,
                analysisDate: new Date().toISOString(),
                answerEngineOptimization: {
                    comparisonContent: aeoData.comparisonContent,
                    summary: {
                        totalScore: aeoData.comparisonContent.score,
                        findings: aeoData.comparisonContent.findings,
                        topRecommendations: aeoData.comparisonContent.recommendations.slice(0, 5)
                    }
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { 
                type: 'application/json' 
            });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `aeo-report-${url.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(downloadUrl);
        }

        function showDetailedAuthorityAnalysis() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.expertAuthority) {
                alert('No Expert Authority analysis available');
                return;
            }
            
            const auth = aeoData.expertAuthority;
            
            const modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.remove()">
                    <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-700">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-white">Expert Authority & E-E-A-T Analysis</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="text-3xl font-bold text-white">${auth.score}/100</div>
                                <div class="text-lg text-gray-300">Expert Authority Analysis</div>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            <div class="bg-blue-900/30 border border-blue-500/20 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-400 mb-3">Authority Signals Breakdown</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${auth.findings.authorBios ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Author Bios: ${auth.findings.authorBios}</div>
                                            <div class="text-sm text-gray-400">Author bio sections detected</div>
                                        </div>
                                    ` : ''}
                                    ${auth.findings.credentials ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Credentials: ${auth.findings.credentials}</div>
                                            <div class="text-sm text-gray-400">Professional credentials found</div>
                                        </div>
                                    ` : ''}
                                    ${auth.findings.experienceIndicators ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Experience: ${auth.findings.experienceIndicators}</div>
                                            <div class="text-sm text-gray-400">Experience indicators found</div>
                                        </div>
                                    ` : ''}
                                    ${auth.findings.authoritySignals ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Authority: ${auth.findings.authoritySignals}</div>
                                            <div class="text-sm text-gray-400">Recognition and authority signals</div>
                                        </div>
                                    ` : ''}
                                    ${auth.findings.contactInfo ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Contact: ${auth.findings.contactInfo}</div>
                                            <div class="text-sm text-gray-400">Transparency and contact information</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${auth.details.length > 0 ? `
                                <div class="bg-gray-800/30 rounded-lg p-4">
                                    <h4 class="font-semibold text-white mb-3">E-E-A-T Analysis Details</h4>
                                    <ul class="text-gray-300 space-y-2">
                                        ${auth.details.map(detail => `<li class="flex items-start gap-2"><i class="fas fa-user-graduate text-blue-400 mt-1"></i><span>${detail}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${auth.recommendations.length > 0 ? `
                                <div class="bg-yellow-900/30 border border-yellow-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-yellow-400 mb-3">Authority Enhancement Recommendations</h4>
                                    <ul class="text-yellow-300 space-y-2">
                                        ${auth.recommendations.map(rec => `<li class="flex items-start gap-2"><i class="fas fa-certificate text-yellow-400 mt-1"></i><span>${rec}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            <div class="bg-green-900/30 border border-green-500/20 rounded-lg p-4">
                                <h4 class="font-semibold text-green-400 mb-3">E-E-A-T Framework</h4>
                                <div class="text-green-300 text-sm">
                                    <p><strong>Experience:</strong> First-hand knowledge and real-world involvement with the topic</p>
                                    <p><strong>Expertise:</strong> Knowledge, skill, and qualifications in the subject area</p>
                                    <p><strong>Authoritativeness:</strong> Recognition as a go-to source by industry or community</p>
                                    <p><strong>Trustworthiness:</strong> Accuracy, honesty, safety, and reliability of content</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function exportAuthorityReport() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.expertAuthority) {
                alert('No Expert Authority analysis available');
                return;
            }

            const url = currentResults.url || 'unknown';
            
            const report = {
                url: url,
                analysisDate: new Date().toISOString(),
                expertAuthorityAnalysis: {
                    overallScore: aeoData.expertAuthority.score,
                    findings: aeoData.expertAuthority.findings,
                    details: aeoData.expertAuthority.details,
                    recommendations: aeoData.expertAuthority.recommendations,
                    eeatFramework: {
                        experience: "First-hand knowledge and real-world involvement with the topic",
                        expertise: "Knowledge, skill, and qualifications in the subject area", 
                        authoritativeness: "Recognition as a go-to source by industry or community",
                        trustworthiness: "Accuracy, honesty, safety, and reliability of content"
                    }
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { 
                type: 'application/json' 
            });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `eeat-authority-report-${url.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(downloadUrl);
        }

        function showDetailedChunkingAnalysis() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.contentChunking) {
                alert('No Content Chunking analysis available');
                return;
            }
            
            const chunk = aeoData.contentChunking;
            
            const modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="this.remove()">
                    <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-700">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-white">Content Chunking & Structure Analysis</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="text-3xl font-bold text-white">${chunk.score}/100</div>
                                <div class="text-lg text-gray-300">AI Parsing Optimization</div>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            ${chunk.findings.paragraphAnalysis ? `
                                <div class="bg-purple-900/30 border border-purple-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-purple-400 mb-3">Paragraph Structure Analysis</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-white">${chunk.findings.paragraphAnalysis.total}</div>
                                            <div class="text-sm text-gray-400">Total Paragraphs</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-green-400">${chunk.findings.paragraphAnalysis.optimal}</div>
                                            <div class="text-sm text-gray-400">Optimal (50-150 words)</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-yellow-400">${chunk.findings.paragraphAnalysis.short}</div>
                                            <div class="text-sm text-gray-400">Short (<50 words)</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-red-400">${chunk.findings.paragraphAnalysis.long}</div>
                                            <div class="text-sm text-gray-400">Long (>150 words)</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${chunk.findings.headingHierarchy ? `
                                <div class="bg-indigo-900/30 border border-indigo-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-indigo-400 mb-3">Heading Hierarchy Analysis</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">H1: ${chunk.findings.headingHierarchy.h1}</div>
                                            <div class="font-medium text-white">H2: ${chunk.findings.headingHierarchy.h2}</div>
                                            <div class="font-medium text-white">H3: ${chunk.findings.headingHierarchy.h3}</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">H4: ${chunk.findings.headingHierarchy.h4}</div>
                                            <div class="font-medium text-white">H5: ${chunk.findings.headingHierarchy.h5}</div>
                                            <div class="font-medium text-white">H6: ${chunk.findings.headingHierarchy.h6}</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Hierarchy Breaks: ${chunk.findings.headingHierarchy.hierarchyBreaks}</div>
                                            <div class="font-medium text-white">Heading Density: ${chunk.findings.headingHierarchy.headingDensity}/1k chars</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${chunk.findings.contentChunking ? `
                                <div class="bg-pink-900/30 border border-pink-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-pink-400 mb-3">Content Structure Elements</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-white">${chunk.findings.contentChunking.lists}</div>
                                            <div class="text-sm text-gray-400">Lists (ul/ol)</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-white">${chunk.findings.contentChunking.listItems}</div>
                                            <div class="text-sm text-gray-400">List Items</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-white">${chunk.findings.contentChunking.visualBreaks}</div>
                                            <div class="text-sm text-gray-400">Visual Breaks</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded text-center">
                                            <div class="font-medium text-white">${chunk.findings.contentChunking.structuredContent}</div>
                                            <div class="text-sm text-gray-400">Structured Elements</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${chunk.findings.readabilityMetrics ? `
                                <div class="bg-green-900/30 border border-green-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-green-400 mb-3">Readability & AI Parsing Metrics</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Average Sentence Length: ${chunk.findings.readabilityMetrics.avgSentenceLength} words</div>
                                            <div class="text-sm text-gray-400">Optimal: 15-25 words per sentence</div>
                                        </div>
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Transition Words: ${chunk.findings.readabilityMetrics.transitionWords}</div>
                                            <div class="text-sm text-gray-400">Content flow indicators found</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${chunk.details.length > 0 ? `
                                <div class="bg-gray-800/30 rounded-lg p-4">
                                    <h4 class="font-semibold text-white mb-3">Detailed Analysis</h4>
                                    <ul class="text-gray-300 space-y-2">
                                        ${chunk.details.map(detail => `<li class="flex items-start gap-2"><i class="fas fa-th-list text-purple-400 mt-1"></i><span>${detail}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${chunk.recommendations.length > 0 ? `
                                <div class="bg-yellow-900/30 border border-yellow-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-yellow-400 mb-3">Structure Optimization Recommendations</h4>
                                    <ul class="text-yellow-300 space-y-2">
                                        ${chunk.recommendations.map(rec => `<li class="flex items-start gap-2"><i class="fas fa-edit text-yellow-400 mt-1"></i><span>${rec}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            <div class="bg-blue-900/30 border border-blue-500/20 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-400 mb-3">AI Parsing Guidelines</h4>
                                <div class="text-blue-300 text-sm">
                                    <p><strong>Optimal Paragraphs:</strong> 50-150 words for AI systems to process effectively</p>
                                    <p><strong>Heading Hierarchy:</strong> Logical H1→H2→H3 progression helps AI understand structure</p>
                                    <p><strong>Content Chunking:</strong> Lists, visual breaks, and structured elements improve scannability</p>
                                    <p><strong>Sentence Length:</strong> 15-25 words per sentence balances clarity and information density</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function exportChunkingReport() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.contentChunking) {
                alert('No Content Chunking analysis available');
                return;
            }

            const url = currentResults.url || 'unknown';
            
            const report = {
                url: url,
                analysisDate: new Date().toISOString(),
                contentChunkingAnalysis: {
                    overallScore: aeoData.contentChunking.score,
                    findings: aeoData.contentChunking.findings,
                    details: aeoData.contentChunking.details,
                    recommendations: aeoData.contentChunking.recommendations,
                    aiParsingGuidelines: {
                        optimalParagraphs: "50-150 words for AI systems to process effectively",
                        headingHierarchy: "Logical H1→H2→H3 progression helps AI understand structure",
                        contentChunking: "Lists, visual breaks, and structured elements improve scannability",
                        sentenceLength: "15-25 words per sentence balances clarity and information density"
                    }
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { 
                type: 'application/json' 
            });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `content-structure-report-${url.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(downloadUrl);
        }

        function showDetailedCitationAnalysis() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.citationQuality) {
                alert('No Citation Quality analysis available');
                return;
            }

            const cite = aeoData.citationQuality;
            const modalContent = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="bg-gradient-to-r from-cyan-900/50 to-teal-900/50 p-6 border-b border-cyan-500/20">
                            <div class="flex items-center justify-between">
                                <h3 class="text-2xl font-bold text-cyan-300 flex items-center gap-3">
                                    <i class="fas fa-link text-3xl"></i>
                                    Citation Quality Analysis
                                </h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="text-3xl font-bold text-white">${cite.score}/100</div>
                                <div class="text-lg text-gray-300">Citation Quality Assessment</div>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(90vh-180px)]">
                            <div class="bg-cyan-900/30 border border-cyan-500/20 rounded-lg p-4">
                                <h4 class="font-semibold text-cyan-400 mb-3">Citation Analysis Breakdown</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${cite.findings.externalLinks ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">External Links: ${cite.findings.externalLinks}</div>
                                            <div class="text-sm text-gray-400">Total outbound references</div>
                                        </div>
                                    ` : ''}
                                    ${cite.findings.authorityDomains ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Authority Domains: ${cite.findings.authorityDomains}</div>
                                            <div class="text-sm text-gray-400">High-authority sources cited</div>
                                        </div>
                                    ` : ''}
                                    ${cite.findings.citationContexts ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Citation Contexts: ${cite.findings.citationContexts}</div>
                                            <div class="text-sm text-gray-400">Properly contextualized citations</div>
                                        </div>
                                    ` : ''}
                                    ${cite.findings.diverseDomains ? `
                                        <div class="bg-gray-800/50 p-3 rounded">
                                            <div class="font-medium text-white">Diverse Sources: ${cite.findings.diverseDomains}</div>
                                            <div class="text-sm text-gray-400">Unique domains referenced</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${cite.findings.authorityBreakdown ? `
                                <div class="bg-gray-800/30 rounded-lg p-4">
                                    <h4 class="font-semibold text-cyan-400 mb-3">Authority Sources by Category</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                        ${cite.findings.authorityBreakdown.government ? `
                                            <div class="text-center p-3 bg-green-900/30 rounded">
                                                <div class="text-xl font-bold text-green-400">${cite.findings.authorityBreakdown.government}</div>
                                                <div class="text-sm text-green-300">Government (.gov, .edu)</div>
                                                <div class="text-xs text-gray-400">Highest authority</div>
                                            </div>
                                        ` : ''}
                                        ${cite.findings.authorityBreakdown.academic ? `
                                            <div class="text-center p-3 bg-blue-900/30 rounded">
                                                <div class="text-xl font-bold text-blue-400">${cite.findings.authorityBreakdown.academic}</div>
                                                <div class="text-sm text-blue-300">Academic Sources</div>
                                                <div class="text-xs text-gray-400">Research & scholarly</div>
                                            </div>
                                        ` : ''}
                                        ${cite.findings.authorityBreakdown.news ? `
                                            <div class="text-center p-3 bg-purple-900/30 rounded">
                                                <div class="text-xl font-bold text-purple-400">${cite.findings.authorityBreakdown.news}</div>
                                                <div class="text-sm text-purple-300">News Media</div>
                                                <div class="text-xs text-gray-400">Reputable journalism</div>
                                            </div>
                                        ` : ''}
                                        ${cite.findings.authorityBreakdown.professional ? `
                                            <div class="text-center p-3 bg-orange-900/30 rounded">
                                                <div class="text-xl font-bold text-orange-400">${cite.findings.authorityBreakdown.professional}</div>
                                                <div class="text-sm text-orange-300">Professional</div>
                                                <div class="text-xs text-gray-400">Industry sources</div>
                                            </div>
                                        ` : ''}
                                        ${cite.findings.authorityBreakdown.statistics ? `
                                            <div class="text-center p-3 bg-yellow-900/30 rounded">
                                                <div class="text-xl font-bold text-yellow-400">${cite.findings.authorityBreakdown.statistics}</div>
                                                <div class="text-sm text-yellow-300">Statistical</div>
                                                <div class="text-xs text-gray-400">Data providers</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${cite.details.length > 0 ? `
                                <div class="bg-gray-800/30 rounded-lg p-4">
                                    <h4 class="font-semibold text-white mb-3">Citation Analysis Details</h4>
                                    <ul class="text-gray-300 space-y-2">
                                        ${cite.details.map(detail => `<li class="flex items-start gap-2"><i class="fas fa-link text-cyan-400 mt-1"></i><span>${detail}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${cite.recommendations.length > 0 ? `
                                <div class="bg-yellow-900/30 border border-yellow-500/20 rounded-lg p-4">
                                    <h4 class="font-semibold text-yellow-400 mb-3">Citation Enhancement Recommendations</h4>
                                    <ul class="text-yellow-300 space-y-2">
                                        ${cite.recommendations.map(rec => `<li class="flex items-start gap-2"><i class="fas fa-lightbulb text-yellow-400 mt-1"></i><span>${rec}</span></li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            <div class="bg-green-900/30 border border-green-500/20 rounded-lg p-4">
                                <h4 class="font-semibold text-green-400 mb-3">Citation Quality Guidelines</h4>
                                <div class="text-green-300 text-sm space-y-2">
                                    <p><strong>Authority Hierarchy:</strong> Government/Educational (.gov/.edu) > Academic (research) > Major News > Professional > General</p>
                                    <p><strong>Context Matters:</strong> Citations with proper context (e.g., "According to X", "Research shows") carry more weight</p>
                                    <p><strong>Source Diversity:</strong> Multiple unique domains demonstrate comprehensive research</p>
                                    <p><strong>AI Optimization:</strong> Well-cited content is preferred by AI systems for factual queries</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function exportCitationReport() {
            const aeoData = currentResults?.tests?.aeo;
            if (!aeoData?.citationQuality) {
                alert('No Citation Quality analysis available');
                return;
            }

            const url = currentResults.url || 'unknown';
            
            const report = {
                url: url,
                analysisDate: new Date().toISOString(),
                citationQualityAnalysis: {
                    overallScore: aeoData.citationQuality.score,
                    findings: aeoData.citationQuality.findings,
                    details: aeoData.citationQuality.details,
                    recommendations: aeoData.citationQuality.recommendations,
                    citationGuidelines: {
                        authorityHierarchy: "Government/Educational > Academic > News Media > Professional > General",
                        contextImportance: "Citations with proper context carry more algorithmic weight",
                        sourceDiversity: "Multiple unique domains demonstrate comprehensive research",
                        aiOptimization: "Well-cited content preferred by AI systems for factual queries"
                    }
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `citation-quality-report-${url.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(downloadUrl);
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            try {
                // Early component initialization
                if (typeof AttentionComponents !== 'undefined' && !components) {
                    try {
                        components = new AttentionComponents();
                        if (components && typeof components.initializeCollapsibles === 'function') {
                            components.initializeCollapsibles();
                        }
                        console.log('AttentionComponents initialized early');
                    } catch (error) {
                        console.warn('Early component initialization failed:', error);
                        components = null;
                    }
                }
                
                checkServerStatus();
                setInterval(checkServerStatus, 30000); // Check every 30s
                
                const urlInput = document.getElementById('urlInput');
                if (urlInput) {
                    urlInput.addEventListener('keypress', (e) => {
                        try {
                            if (e.key === 'Enter') {
                                startFullAudit();
                            }
                        } catch (error) {
                            console.error('Error in Enter key handler:', error);
                        }
                    });
                }
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
                // Fallback to basic functionality
                try {
                    checkServerStatus();
                } catch (fallbackError) {
                    console.error('Fallback checkServerStatus failed:', fallbackError);
                }
            }
        });
    </script>
</body>
</html>